<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebaseå®æ—¶åä½œå¢å¼ºæµ‹è¯•</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .test-section {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .test-section:hover {
            border-color: #007bff;
            box-shadow: 0 5px 15px rgba(0,123,255,0.1);
        }
        
        .test-section h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,123,255,0.4);
        }
        
        .test-button:active {
            transform: translateY(0);
        }
        
        .test-button.secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            box-shadow: 0 4px 15px rgba(108,117,125,0.3);
        }
        
        .test-button.danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            box-shadow: 0 4px 15px rgba(220,53,69,0.3);
        }
        
        .test-button.success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            box-shadow: 0 4px 15px rgba(40,167,69,0.3);
        }
        
        .status-display {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            color: #2c3e50;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .feature-card {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            border-color: #007bff;
            box-shadow: 0 10px 25px rgba(0,123,255,0.1);
        }
        
        .feature-card .icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .feature-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .feature-card p {
            color: #6c757d;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .debug-panel {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .debug-panel h4 {
            color: #3498db;
            margin: 0 0 10px 0;
        }
        
        .connection-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .connection-indicator.connected {
            background: #27ae60;
        }
        
        .connection-indicator.disconnected {
            background: #e74c3c;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        .alert {
            padding: 12px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .alert.info {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>ğŸš€ Firebaseå®æ—¶åä½œå¢å¼ºæµ‹è¯•</h1>
            <p>æµ‹è¯•æ”¹è¿›çš„å¤šäººåä½œåŠŸèƒ½ï¼šå¿ƒè·³æœºåˆ¶ã€æ–­çº¿é‡è¿ã€å®æ—¶ç”¨æˆ·çŠ¶æ€ã€ç¦»çº¿æ£€æµ‹ç­‰</p>
        </div>

        <!-- æ–°åŠŸèƒ½ç‰¹æ€§ -->
        <div class="test-section">
            <h3>âœ¨ å¢å¼ºåŠŸèƒ½ç‰¹æ€§</h3>
            <div class="feature-grid">
                <div class="feature-card">
                    <div class="icon">ğŸ’“</div>
                    <h4>å¿ƒè·³æœºåˆ¶</h4>
                    <p>æ¯30ç§’è‡ªåŠ¨å‘é€å¿ƒè·³ï¼Œå‡†ç¡®æ£€æµ‹ç”¨æˆ·åœ¨çº¿çŠ¶æ€</p>
                </div>
                <div class="feature-card">
                    <div class="icon">ğŸ”„</div>
                    <h4>æ–­çº¿é‡è¿</h4>
                    <p>ç½‘ç»œä¸­æ–­åè‡ªåŠ¨æ¢å¤è¿æ¥ï¼ŒåŒæ­¥æœ€æ–°æ•°æ®</p>
                </div>
                <div class="feature-card">
                    <div class="icon">ğŸ‘¥</div>
                    <h4>å®æ—¶ç”¨æˆ·åˆ—è¡¨</h4>
                    <p>æ˜¾ç¤ºè¯¦ç»†çš„ç”¨æˆ·çŠ¶æ€ã€æœ€åæ´»è·ƒæ—¶é—´å’Œè¿æ¥çŠ¶æ€</p>
                </div>
                <div class="feature-card">
                    <div class="icon">âš¡</div>
                    <h4>ç¦»çº¿æ£€æµ‹</h4>
                    <p>æ™ºèƒ½æ£€æµ‹ç”¨æˆ·ç¦»çº¿çŠ¶æ€ï¼Œæ”¯æŒä¼˜é›…çš„ç¦»çº¿å¤„ç†</p>
                </div>
            </div>
        </div>

        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="test-section">
            <h3>ğŸŒ è¿æ¥çŠ¶æ€ç›‘æ§</h3>
            <div class="status-display" id="connection-status">
                <span class="connection-indicator disconnected"></span>æœªè¿æ¥
            </div>
            <button class="test-button" onclick="testConnectionMonitoring()">æµ‹è¯•è¿æ¥ç›‘æ§</button>
            <button class="test-button secondary" onclick="simulateDisconnection()">æ¨¡æ‹Ÿæ–­çº¿</button>
        </div>

        <!-- æˆ¿é—´ç®¡ç† -->
        <div class="test-section">
            <h3>ğŸ  æˆ¿é—´ç®¡ç†æµ‹è¯•</h3>
            <button class="test-button" onclick="createTestRoom()">åˆ›å»ºæµ‹è¯•æˆ¿é—´</button>
            <button class="test-button secondary" onclick="joinTestRoom()">åŠ å…¥æµ‹è¯•æˆ¿é—´</button>
            <button class="test-button danger" onclick="leaveCurrentRoom()">ç¦»å¼€å½“å‰æˆ¿é—´</button>
            <div class="debug-panel" id="room-status">
                <h4>æˆ¿é—´çŠ¶æ€</h4>
                <div id="room-info-debug">æš‚æ— æˆ¿é—´ä¿¡æ¯</div>
            </div>
        </div>

        <!-- ç”¨æˆ·åŒæ­¥æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ‘¤ ç”¨æˆ·åŒæ­¥æµ‹è¯•</h3>
            <button class="test-button" onclick="testUserPresence()">æµ‹è¯•ç”¨æˆ·çŠ¶æ€</button>
            <button class="test-button secondary" onclick="updateUserInfo()">æ›´æ–°ç”¨æˆ·ä¿¡æ¯</button>
            <button class="test-button success" onclick="debugUserList()">è°ƒè¯•ç”¨æˆ·åˆ—è¡¨</button>
            <div class="status-display" id="user-sync-status">ç­‰å¾…ç”¨æˆ·æ“ä½œ...</div>
        </div>

        <!-- å¿ƒè·³æœºåˆ¶æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ’“ å¿ƒè·³æœºåˆ¶æµ‹è¯•</h3>
            <button class="test-button" onclick="startHeartbeatTest()">å¯åŠ¨å¿ƒè·³æµ‹è¯•</button>
            <button class="test-button danger" onclick="stopHeartbeatTest()">åœæ­¢å¿ƒè·³æµ‹è¯•</button>
            <div class="debug-panel" id="heartbeat-logs">
                <h4>å¿ƒè·³æ—¥å¿—</h4>
                <div id="heartbeat-info">å¿ƒè·³æœºåˆ¶æœªå¯åŠ¨</div>
            </div>
        </div>

        <!-- å®æ—¶åä½œæµ‹è¯• -->
        <div class="test-section">
            <h3>âš¡ å®æ—¶åä½œæµ‹è¯•</h3>
            <p>æ‰“å¼€å¤šä¸ªæµè§ˆå™¨æ ‡ç­¾é¡µæˆ–è®¾å¤‡æ¥æµ‹è¯•å®æ—¶åŒæ­¥</p>
            <button class="test-button" onclick="openMultipleWindows()">æ‰“å¼€å¤šä¸ªæµ‹è¯•çª—å£</button>
            <button class="test-button secondary" onclick="testRealTimeSync()">æµ‹è¯•å®æ—¶åŒæ­¥</button>
            <div class="alert info">
                ğŸ’¡ å»ºè®®ï¼šåœ¨ä¸åŒè®¾å¤‡æˆ–æµè§ˆå™¨ä¸­æ‰“å¼€æ­¤é¡µé¢ï¼Œåˆ›å»ºæˆ¿é—´ååˆ†äº«æˆ¿é—´å·æµ‹è¯•çœŸå®çš„å¤šäººåä½œ
            </div>
        </div>

        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <div class="test-section">
            <h3>ğŸ” è°ƒè¯•ä¿¡æ¯</h3>
            <button class="test-button secondary" onclick="showDebugInfo()">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
            <button class="test-button secondary" onclick="clearLogs()">æ¸…ç†æ—¥å¿—</button>
            <div class="debug-panel" id="debug-logs">
                <h4>è°ƒè¯•æ—¥å¿—</h4>
                <div id="debug-content">ç­‰å¾…è°ƒè¯•ä¿¡æ¯...</div>
            </div>
        </div>
    </div>

    <!-- Firebaseé…ç½®å’Œè„šæœ¬ -->
    <script type="module">
        import { FirebaseCollaborationManager } from './js/modules/firebaseCollaborationManager.js';
        import { StorageManager } from './js/modules/storageManager.js';
        import { UiManager } from './js/modules/uiManager.js';
        import { StatsManager } from './js/modules/statsManager.js';

        // åˆå§‹åŒ–ç®¡ç†å™¨
        const storageManager = new StorageManager();
        const uiManager = new UiManager();
        const statsManager = new StatsManager();
        const firebaseManager = new FirebaseCollaborationManager(storageManager, uiManager, statsManager);

        // å…¨å±€å˜é‡
        window.firebaseManager = firebaseManager;
        window.heartbeatTestInterval = null;

        // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
        function updateConnectionDisplay(isConnected) {
            const statusElement = document.getElementById('connection-status');
            const indicator = statusElement.querySelector('.connection-indicator');
            
            if (isConnected) {
                statusElement.innerHTML = '<span class="connection-indicator connected"></span>å·²è¿æ¥åˆ°Firebase';
                indicator.className = 'connection-indicator connected';
            } else {
                statusElement.innerHTML = '<span class="connection-indicator disconnected"></span>è¿æ¥å·²æ–­å¼€';
                indicator.className = 'connection-indicator disconnected';
            }
        }

        // è¿æ¥çŠ¶æ€ç›‘æ§
        window.testConnectionMonitoring = function() {
            log('å¼€å§‹æµ‹è¯•è¿æ¥ç›‘æ§...');
            if (firebaseManager.isConnected) {
                updateConnectionDisplay(true);
                log('âœ… Firebaseè¿æ¥æ­£å¸¸');
            } else {
                updateConnectionDisplay(false);
                log('âŒ Firebaseè¿æ¥æ–­å¼€');
            }
        };

        // æ¨¡æ‹Ÿæ–­çº¿
        window.simulateDisconnection = function() {
            log('æ¨¡æ‹Ÿç½‘ç»œæ–­çº¿ï¼ˆä»…UIæ¼”ç¤ºï¼‰...');
            updateConnectionDisplay(false);
            setTimeout(() => {
                log('ç½‘ç»œå·²æ¢å¤');
                updateConnectionDisplay(true);
            }, 3000);
        };

        // åˆ›å»ºæµ‹è¯•æˆ¿é—´
        window.createTestRoom = async function() {
            log('åˆ›å»ºæµ‹è¯•æˆ¿é—´...');
            const roomId = await firebaseManager.createRoom();
            if (roomId) {
                log(`âœ… æˆ¿é—´åˆ›å»ºæˆåŠŸ: ${roomId}`);
                updateRoomStatus();
            } else {
                log('âŒ æˆ¿é—´åˆ›å»ºå¤±è´¥');
            }
        };

        // åŠ å…¥æµ‹è¯•æˆ¿é—´
        window.joinTestRoom = async function() {
            const roomId = prompt('è¯·è¾“å…¥æˆ¿é—´å·:');
            if (!roomId) return;
            
            log(`åŠ å…¥æˆ¿é—´: ${roomId}...`);
            const success = await firebaseManager.joinRoom(roomId);
            if (success) {
                log(`âœ… æˆåŠŸåŠ å…¥æˆ¿é—´: ${roomId}`);
                updateRoomStatus();
            } else {
                log('âŒ åŠ å…¥æˆ¿é—´å¤±è´¥');
            }
        };

        // ç¦»å¼€å½“å‰æˆ¿é—´
        window.leaveCurrentRoom = async function() {
            if (!firebaseManager.roomId) {
                log('âŒ å½“å‰æ²¡æœ‰åŠ å…¥ä»»ä½•æˆ¿é—´');
                return;
            }
            
            log('ç¦»å¼€å½“å‰æˆ¿é—´...');
            await firebaseManager.leaveRoom();
            log('âœ… å·²ç¦»å¼€æˆ¿é—´');
            updateRoomStatus();
        };

        // æ›´æ–°æˆ¿é—´çŠ¶æ€
        function updateRoomStatus() {
            const roomInfo = document.getElementById('room-info-debug');
            if (firebaseManager.roomId) {
                roomInfo.innerHTML = `
æˆ¿é—´ID: ${firebaseManager.roomId}
ç”¨æˆ·ID: ${firebaseManager.userId}
ç”¨æˆ·å: ${firebaseManager.userName}
è§’è‰²: ${firebaseManager.isHost ? 'æˆ¿ä¸»' : 'æˆå‘˜'}
è¿æ¥çŠ¶æ€: ${firebaseManager.isConnected ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                `;
            } else {
                roomInfo.innerHTML = 'æš‚æ— æˆ¿é—´ä¿¡æ¯';
            }
        }

        // æµ‹è¯•ç”¨æˆ·çŠ¶æ€
        window.testUserPresence = function() {
            log('æµ‹è¯•ç”¨æˆ·åœ¨çº¿çŠ¶æ€...');
            if (firebaseManager.roomId) {
                firebaseManager.updateUserPresence();
                log('âœ… ç”¨æˆ·çŠ¶æ€å·²æ›´æ–°');
            } else {
                log('âŒ è¯·å…ˆåŠ å…¥æˆ¿é—´');
            }
        };

        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        window.updateUserInfo = function() {
            const newName = prompt('è¾“å…¥æ–°ç”¨æˆ·å:', firebaseManager.userName);
            if (newName && newName !== firebaseManager.userName) {
                firebaseManager.userName = newName;
                localStorage.setItem('firebase_collaboration_userName', newName);
                log(`âœ… ç”¨æˆ·åå·²æ›´æ–°ä¸º: ${newName}`);
            }
        };

        // è°ƒè¯•ç”¨æˆ·åˆ—è¡¨
        window.debugUserList = function() {
            log('è°ƒè¯•ç”¨æˆ·åˆ—è¡¨...');
            firebaseManager.debugRoomUsers();
        };

        // å¯åŠ¨å¿ƒè·³æµ‹è¯•
        window.startHeartbeatTest = function() {
            if (window.heartbeatTestInterval) {
                clearInterval(window.heartbeatTestInterval);
            }
            
            log('å¯åŠ¨å¿ƒè·³æµ‹è¯•...');
            const heartbeatInfo = document.getElementById('heartbeat-info');
            let count = 0;
            
            window.heartbeatTestInterval = setInterval(() => {
                count++;
                const timestamp = new Date().toLocaleTimeString();
                heartbeatInfo.innerHTML = `å¿ƒè·³æµ‹è¯•è¿è¡Œä¸­... ç¬¬${count}æ¬¡å¿ƒè·³ [${timestamp}]`;
                log(`ğŸ’“ å¿ƒè·³ #${count} - ${timestamp}`);
            }, 5000); // æµ‹è¯•ç”¨è¾ƒçŸ­é—´éš”
        };

        // åœæ­¢å¿ƒè·³æµ‹è¯•
        window.stopHeartbeatTest = function() {
            if (window.heartbeatTestInterval) {
                clearInterval(window.heartbeatTestInterval);
                window.heartbeatTestInterval = null;
                document.getElementById('heartbeat-info').innerHTML = 'å¿ƒè·³æµ‹è¯•å·²åœæ­¢';
                log('âŒ å¿ƒè·³æµ‹è¯•å·²åœæ­¢');
            }
        };

        // æ‰“å¼€å¤šä¸ªæµ‹è¯•çª—å£
        window.openMultipleWindows = function() {
            const currentUrl = window.location.href;
            for (let i = 1; i <= 2; i++) {
                setTimeout(() => {
                    window.open(currentUrl, `test_window_${i}`, 'width=800,height=600,left=' + (i * 50) + ',top=' + (i * 50));
                }, i * 500);
            }
            log('âœ… å·²æ‰“å¼€å¤šä¸ªæµ‹è¯•çª—å£');
        };

        // æµ‹è¯•å®æ—¶åŒæ­¥
        window.testRealTimeSync = function() {
            if (!firebaseManager.roomId) {
                log('âŒ è¯·å…ˆåˆ›å»ºæˆ–åŠ å…¥æˆ¿é—´');
                return;
            }
            
            log('æµ‹è¯•å®æ—¶åŒæ­¥åŠŸèƒ½...');
            log('ğŸ’¡ è¯·åœ¨å…¶ä»–çª—å£æˆ–è®¾å¤‡ä¸­æ‰§è¡Œæ“ä½œï¼Œè§‚å¯ŸåŒæ­¥æ•ˆæœ');
        };

        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        window.showDebugInfo = function() {
            const debugContent = document.getElementById('debug-content');
            debugContent.innerHTML = `
Firebaseåˆå§‹åŒ–çŠ¶æ€: ${firebaseManager.isInitialized}
è¿æ¥çŠ¶æ€: ${firebaseManager.isConnected}
æ¼”ç¤ºæ¨¡å¼: ${firebaseManager.isDemoMode}
ç”¨æˆ·ID: ${firebaseManager.userId || 'null'}
æˆ¿é—´ID: ${firebaseManager.roomId || 'null'}
æ˜¯å¦æˆ¿ä¸»: ${firebaseManager.isHost}
ç”¨æˆ·å: ${firebaseManager.userName || 'null'}
ç”¨æˆ·é¢œè‰²: ${firebaseManager.userColor || 'null'}
å¿ƒè·³çŠ¶æ€: ${firebaseManager.heartbeatInterval ? 'è¿è¡Œä¸­' : 'æœªå¯åŠ¨'}
æµè§ˆå™¨: ${navigator.userAgent}
            `;
        };

        // æ¸…ç†æ—¥å¿—
        window.clearLogs = function() {
            document.getElementById('user-sync-status').innerHTML = 'ç­‰å¾…ç”¨æˆ·æ“ä½œ...';
            document.getElementById('debug-content').innerHTML = 'ç­‰å¾…è°ƒè¯•ä¿¡æ¯...';
            log('ğŸ§¹ æ—¥å¿—å·²æ¸…ç†');
        };

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            
            const statusElement = document.getElementById('user-sync-status');
            statusElement.innerHTML += logMessage + '\n';
            statusElement.scrollTop = statusElement.scrollHeight;
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼ŒFirebaseå¢å¼ºæµ‹è¯•ç³»ç»Ÿå·²å¯åŠ¨');
            updateRoomStatus();
            
            // ç›‘å¬Firebaseè¿æ¥çŠ¶æ€å˜åŒ–
            setInterval(() => {
                if (firebaseManager.isInitialized) {
                    updateConnectionDisplay(firebaseManager.isConnected);
                }
            }, 2000);
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (window.heartbeatTestInterval) {
                clearInterval(window.heartbeatTestInterval);
            }
        });
    </script>
</body>
</html>
