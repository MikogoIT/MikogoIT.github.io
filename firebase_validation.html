<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebaseåä½œåŠŸèƒ½éªŒè¯</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .validation-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .test-item {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .test-item.success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .test-item.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .status-display {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="validation-container">
        <h1>ğŸ” Firebaseåä½œåŠŸèƒ½éªŒè¯</h1>
        <p>éªŒè¯å¢å¼ºçš„å¤šäººåä½œåŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>

        <div class="test-item">
            <h3>1. Firebaseåˆå§‹åŒ–éªŒè¯</h3>
            <button class="test-button" onclick="validateFirebaseInit()">æ£€æŸ¥Firebaseåˆå§‹åŒ–</button>
            <div id="firebase-init-result"></div>
        </div>

        <div class="test-item">
            <h3>2. è¿æ¥çŠ¶æ€ç›‘æ§éªŒè¯</h3>
            <button class="test-button" onclick="validateConnectionMonitoring()">æ£€æŸ¥è¿æ¥ç›‘æ§</button>
            <div id="connection-monitoring-result"></div>
        </div>

        <div class="test-item">
            <h3>3. å¿ƒè·³æœºåˆ¶éªŒè¯</h3>
            <button class="test-button" onclick="validateHeartbeat()">æ£€æŸ¥å¿ƒè·³æœºåˆ¶</button>
            <div id="heartbeat-result"></div>
        </div>

        <div class="test-item">
            <h3>4. ç”¨æˆ·çŠ¶æ€ç®¡ç†éªŒè¯</h3>
            <button class="test-button" onclick="validateUserManagement()">æ£€æŸ¥ç”¨æˆ·ç®¡ç†</button>
            <div id="user-management-result"></div>
        </div>

        <div class="test-item">
            <h3>5. æˆ¿é—´ä¿¡æ¯ç»„ä»¶éªŒè¯</h3>
            <button class="test-button" onclick="validateRoomInfoComponent()">æ£€æŸ¥æˆ¿é—´ç»„ä»¶</button>
            <div id="room-component-result"></div>
        </div>

        <div class="test-item">
            <h3>6. å¿«é€ŸåŠŸèƒ½æµ‹è¯•</h3>
            <button class="test-button" onclick="quickTest()">å¿«é€Ÿæµ‹è¯•</button>
            <button class="test-button" onclick="createTestRoom()">åˆ›å»ºæµ‹è¯•æˆ¿é—´</button>
            <button class="test-button" onclick="simulateUser()">æ¨¡æ‹Ÿå¤šç”¨æˆ·</button>
        </div>

        <div class="status-display" id="validation-logs">
ç­‰å¾…éªŒè¯å¼€å§‹...
        </div>
    </div>

    <script type="module">
        import { FirebaseCollaborationManager } from './js/modules/firebaseCollaborationManager.js';
        import { StorageManager } from './js/modules/storageManager.js';
        import { UiManager } from './js/modules/uiManager.js';
        import { StatsManager } from './js/modules/statsManager.js';

        // åˆå§‹åŒ–ç®¡ç†å™¨
        const storageManager = new StorageManager();
        const uiManager = new UiManager();
        const statsManager = new StatsManager();
        let firebaseManager;

        // åˆå§‹åŒ–Firebaseç®¡ç†å™¨
        try {
            firebaseManager = new FirebaseCollaborationManager(storageManager, uiManager, statsManager);
            window.firebaseManager = firebaseManager;
            log('âœ… Firebaseç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ');
        } catch (error) {
            log('âŒ Firebaseç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥: ' + error.message);
        }

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('validation-logs');
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        // éªŒè¯ç»“æœæ˜¾ç¤º
        function showResult(elementId, success, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div style="margin-top: 10px; padding: 10px; background: ${success ? '#d4edda' : '#f8d7da'}; border-radius: 4px; color: ${success ? '#155724' : '#721c24'};">${success ? 'âœ…' : 'âŒ'} ${message}</div>`;
        }

        // 1. Firebaseåˆå§‹åŒ–éªŒè¯
        window.validateFirebaseInit = function() {
            log('å¼€å§‹éªŒè¯Firebaseåˆå§‹åŒ–...');
            
            if (!firebaseManager) {
                showResult('firebase-init-result', false, 'Firebaseç®¡ç†å™¨æœªåˆ›å»º');
                return;
            }

            const checks = [
                { name: 'Firebaseåº”ç”¨', value: firebaseManager.app },
                { name: 'Firebaseè®¤è¯', value: firebaseManager.auth },
                { name: 'Firebaseæ•°æ®åº“', value: firebaseManager.database },
                { name: 'åˆå§‹åŒ–çŠ¶æ€', value: firebaseManager.isInitialized },
                { name: 'ç”¨æˆ·ID', value: firebaseManager.userId },
                { name: 'ç”¨æˆ·å', value: firebaseManager.userName },
                { name: 'ç”¨æˆ·é¢œè‰²', value: firebaseManager.userColor }
            ];

            let allPassed = true;
            let details = '';

            checks.forEach(check => {
                const passed = check.value !== null && check.value !== undefined;
                allPassed = allPassed && passed;
                details += `${check.name}: ${passed ? 'âœ…' : 'âŒ'} ${check.value || 'null'}\n`;
                log(`${check.name}: ${passed ? 'OK' : 'FAIL'}`);
            });

            showResult('firebase-init-result', allPassed, `åˆå§‹åŒ–æ£€æŸ¥${allPassed ? 'é€šè¿‡' : 'å¤±è´¥'}\n${details}`);
        };

        // 2. è¿æ¥çŠ¶æ€ç›‘æ§éªŒè¯
        window.validateConnectionMonitoring = function() {
            log('å¼€å§‹éªŒè¯è¿æ¥çŠ¶æ€ç›‘æ§...');
            
            const hasConnectionState = typeof firebaseManager.isConnected === 'boolean';
            const hasMonitoring = typeof firebaseManager.setupConnectionMonitoring === 'function';
            const hasReconnectionHandler = typeof firebaseManager.handleReconnection === 'function';

            const passed = hasConnectionState && hasMonitoring && hasReconnectionHandler;

            let details = `è¿æ¥çŠ¶æ€: ${firebaseManager.isConnected ? 'åœ¨çº¿' : 'ç¦»çº¿'}\n`;
            details += `ç›‘æ§å‡½æ•°: ${hasMonitoring ? 'å­˜åœ¨' : 'ç¼ºå¤±'}\n`;
            details += `é‡è¿å¤„ç†: ${hasReconnectionHandler ? 'å­˜åœ¨' : 'ç¼ºå¤±'}`;

            showResult('connection-monitoring-result', passed, details);
            log(`è¿æ¥ç›‘æ§éªŒè¯: ${passed ? 'PASS' : 'FAIL'}`);
        };

        // 3. å¿ƒè·³æœºåˆ¶éªŒè¯
        window.validateHeartbeat = function() {
            log('å¼€å§‹éªŒè¯å¿ƒè·³æœºåˆ¶...');
            
            const hasStartHeartbeat = typeof firebaseManager.startHeartbeat === 'function';
            const hasStopHeartbeat = typeof firebaseManager.stopHeartbeat === 'function';
            const hasUpdatePresence = typeof firebaseManager.updateUserPresence === 'function';

            const passed = hasStartHeartbeat && hasStopHeartbeat && hasUpdatePresence;

            let details = `å¯åŠ¨å¿ƒè·³å‡½æ•°: ${hasStartHeartbeat ? 'å­˜åœ¨' : 'ç¼ºå¤±'}\n`;
            details += `åœæ­¢å¿ƒè·³å‡½æ•°: ${hasStopHeartbeat ? 'å­˜åœ¨' : 'ç¼ºå¤±'}\n`;
            details += `æ›´æ–°çŠ¶æ€å‡½æ•°: ${hasUpdatePresence ? 'å­˜åœ¨' : 'ç¼ºå¤±'}\n`;
            details += `å¿ƒè·³çŠ¶æ€: ${firebaseManager.heartbeatInterval ? 'è¿è¡Œä¸­' : 'æœªå¯åŠ¨'}`;

            showResult('heartbeat-result', passed, details);
            log(`å¿ƒè·³æœºåˆ¶éªŒè¯: ${passed ? 'PASS' : 'FAIL'}`);
        };

        // 4. ç”¨æˆ·çŠ¶æ€ç®¡ç†éªŒè¯
        window.validateUserManagement = function() {
            log('å¼€å§‹éªŒè¯ç”¨æˆ·çŠ¶æ€ç®¡ç†...');
            
            const hasUserListUpdate = typeof firebaseManager.updateRoomInfoUsersList === 'function';
            const hasUserOnlineCheck = typeof firebaseManager.isUserOnline === 'function';
            const hasUserHandleChange = typeof firebaseManager.handleUsersChange === 'function';
            const hasLastSeenText = typeof firebaseManager.getLastSeenText === 'function';

            const passed = hasUserListUpdate && hasUserOnlineCheck && hasUserHandleChange && hasLastSeenText;

            let details = `ç”¨æˆ·åˆ—è¡¨æ›´æ–°: ${hasUserListUpdate ? 'å­˜åœ¨' : 'ç¼ºå¤±'}\n`;
            details += `åœ¨çº¿çŠ¶æ€æ£€æŸ¥: ${hasUserOnlineCheck ? 'å­˜åœ¨' : 'ç¼ºå¤±'}\n`;
            details += `ç”¨æˆ·å˜åŒ–å¤„ç†: ${hasUserHandleChange ? 'å­˜åœ¨' : 'ç¼ºå¤±'}\n`;
            details += `æœ€åæ´»è·ƒæ—¶é—´: ${hasLastSeenText ? 'å­˜åœ¨' : 'ç¼ºå¤±'}`;

            showResult('user-management-result', passed, details);
            log(`ç”¨æˆ·ç®¡ç†éªŒè¯: ${passed ? 'PASS' : 'FAIL'}`);
        };

        // 5. æˆ¿é—´ä¿¡æ¯ç»„ä»¶éªŒè¯
        window.validateRoomInfoComponent = function() {
            log('å¼€å§‹éªŒè¯æˆ¿é—´ä¿¡æ¯ç»„ä»¶...');
            
            const hasShowRoomInfo = typeof firebaseManager.showRoomInfo === 'function';
            const hasHideRoomInfo = typeof firebaseManager.hideRoomInfo === 'function';
            const hasCopyRoomId = typeof firebaseManager.copyRoomId === 'function';

            // æ£€æŸ¥CSSæ ·å¼æ˜¯å¦å­˜åœ¨
            const hasRoomInfoStyles = document.querySelector('style') || 
                                    Array.from(document.styleSheets).some(sheet => {
                                        try {
                                            return Array.from(sheet.cssRules).some(rule => 
                                                rule.selectorText && rule.selectorText.includes('.room-info')
                                            );
                                        } catch(e) {
                                            return false;
                                        }
                                    });

            const passed = hasShowRoomInfo && hasHideRoomInfo && hasCopyRoomId;

            let details = `æ˜¾ç¤ºæˆ¿é—´ä¿¡æ¯: ${hasShowRoomInfo ? 'å­˜åœ¨' : 'ç¼ºå¤±'}\n`;
            details += `éšè—æˆ¿é—´ä¿¡æ¯: ${hasHideRoomInfo ? 'å­˜åœ¨' : 'ç¼ºå¤±'}\n`;
            details += `å¤åˆ¶æˆ¿é—´å·: ${hasCopyRoomId ? 'å­˜åœ¨' : 'ç¼ºå¤±'}\n`;
            details += `CSSæ ·å¼: ${hasRoomInfoStyles ? 'å·²åŠ è½½' : 'æœªæ‰¾åˆ°'}`;

            showResult('room-component-result', passed, details);
            log(`æˆ¿é—´ç»„ä»¶éªŒè¯: ${passed ? 'PASS' : 'FAIL'}`);
        };

        // 6. å¿«é€ŸåŠŸèƒ½æµ‹è¯•
        window.quickTest = function() {
            log('å¼€å§‹å¿«é€ŸåŠŸèƒ½æµ‹è¯•...');
            log('1. æ£€æŸ¥Firebaseè¿æ¥...');
            
            setTimeout(() => {
                if (firebaseManager.isConnected) {
                    log('âœ… Firebaseè¿æ¥æ­£å¸¸');
                } else {
                    log('âš ï¸ Firebaseæœªè¿æ¥æˆ–è¿æ¥ä¸­');
                }
                
                log('2. æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯...');
                if (firebaseManager.userName && firebaseManager.userColor) {
                    log(`âœ… ç”¨æˆ·ä¿¡æ¯: ${firebaseManager.userName} (${firebaseManager.userColor})`);
                } else {
                    log('âš ï¸ ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´');
                }
                
                log('3. æµ‹è¯•UIç»„ä»¶...');
                if (typeof firebaseManager.showTemporaryMessage === 'function') {
                    firebaseManager.showTemporaryMessage('è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¶ˆæ¯', 'success');
                    log('âœ… ä¸´æ—¶æ¶ˆæ¯ç»„ä»¶æ­£å¸¸');
                } else {
                    log('âŒ ä¸´æ—¶æ¶ˆæ¯ç»„ä»¶ç¼ºå¤±');
                }
                
                log('å¿«é€Ÿæµ‹è¯•å®Œæˆ');
            }, 1000);
        };

        // åˆ›å»ºæµ‹è¯•æˆ¿é—´
        window.createTestRoom = async function() {
            log('åˆ›å»ºæµ‹è¯•æˆ¿é—´...');
            try {
                const roomId = await firebaseManager.createRoom();
                if (roomId) {
                    log(`âœ… æµ‹è¯•æˆ¿é—´åˆ›å»ºæˆåŠŸ: ${roomId}`);
                    
                    // éªŒè¯æˆ¿é—´ä¿¡æ¯ç»„ä»¶æ˜¯å¦æ˜¾ç¤º
                    setTimeout(() => {
                        const roomInfoElement = document.getElementById('room-info');
                        if (roomInfoElement) {
                            log('âœ… æˆ¿é—´ä¿¡æ¯ç»„ä»¶å·²æ˜¾ç¤º');
                        } else {
                            log('âš ï¸ æˆ¿é—´ä¿¡æ¯ç»„ä»¶æœªæ˜¾ç¤º');
                        }
                    }, 1000);
                } else {
                    log('âŒ æµ‹è¯•æˆ¿é—´åˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                log('âŒ åˆ›å»ºæˆ¿é—´æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            }
        };

        // æ¨¡æ‹Ÿå¤šç”¨æˆ·
        window.simulateUser = function() {
            log('æ¨¡æ‹Ÿå¤šç”¨æˆ·æ•°æ®...');
            
            const mockUsers = {
                'user1': {
                    userName: 'æµ‹è¯•ç”¨æˆ·1',
                    userColor: '#e74c3c',
                    isHost: false,
                    isOnline: true,
                    lastSeen: Date.now(),
                    lastHeartbeat: Date.now()
                },
                'user2': {
                    userName: 'æµ‹è¯•ç”¨æˆ·2', 
                    userColor: '#2ecc71',
                    isHost: false,
                    isOnline: false,
                    lastSeen: Date.now() - 300000,
                    lastHeartbeat: Date.now() - 180000
                }
            };
            
            // å¦‚æœæœ‰å½“å‰ç”¨æˆ·ï¼Œæ·»åŠ åˆ°æ¨¡æ‹Ÿæ•°æ®ä¸­
            if (firebaseManager.userId) {
                mockUsers[firebaseManager.userId] = {
                    userName: firebaseManager.userName,
                    userColor: firebaseManager.userColor,
                    isHost: firebaseManager.isHost,
                    isOnline: true,
                    lastSeen: Date.now(),
                    lastHeartbeat: Date.now()
                };
            }
            
            // æ›´æ–°ç”¨æˆ·åˆ—è¡¨æ˜¾ç¤º
            firebaseManager.updateRoomInfoUsersList(mockUsers);
            log('âœ… æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®å·²åº”ç”¨åˆ°ç”¨æˆ·åˆ—è¡¨');
        };

        // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨
        window.addEventListener('load', () => {
            log('éªŒè¯é¡µé¢åŠ è½½å®Œæˆ');
            log('å»ºè®®æŒ‰é¡ºåºæ‰§è¡ŒéªŒè¯æµ‹è¯•');
            
            // ç­‰å¾…Firebaseåˆå§‹åŒ–
            setTimeout(() => {
                if (firebaseManager && firebaseManager.isInitialized) {
                    log('âœ… Firebaseå·²åˆå§‹åŒ–ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
                } else {
                    log('âš ï¸ Firebaseåˆå§‹åŒ–ä¸­ï¼Œè¯·ç¨åå†è¯•');
                }
            }, 2000);
        });
    </script>
</body>
</html>
