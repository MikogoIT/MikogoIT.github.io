<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘çŒªåˆ·æ–°ç›‘æ§ç³»ç»Ÿ</title>
    
    <!-- å¤–éƒ¨æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/animations.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>é‡‘çŒªåˆ·æ–°ç›‘æ§ç³»ç»Ÿ <span class="gold-pig">ğŸ·</span></h1>
            <p class="subtitle">ç›‘æ§æ¯æ¡çº¿è·¯çš„é‡‘çŒªçŠ¶æ€ï¼Œæ ‡è®°å‡»æ€åè‡ªåŠ¨å¼€å§‹24å°æ—¶å€’è®¡æ—¶</p>
        </header>
        
        <div class="dashboard">
            <div class="controls">
                <div class="panel-title">
                    â„¹ï¸
                    <h2>æ“ä½œé¢æ¿ <span class="status-indicator status-active"></span></h2>
                </div>
                
                <div class="instructions">
                    <h3>ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
                    <ul>
                        <li class="desktop-instruction">
                            ğŸ–±ï¸
                            <span class="highlight">å·¦é”®å•å‡»çº¿è·¯æ ¼å­</span> - æ ‡è®°é‡‘çŒªè¢«å‡»æ€ï¼ˆå¼€å§‹24å°æ—¶å€’è®¡æ—¶ï¼‰
                        </li>
                        <li class="desktop-instruction">
                            ğŸ‘†
                            <span class="highlight">å³é”®å•å‡»çº¿è·¯æ ¼å­</span> - æ ‡è®°é‡‘çŒªè¢«å‡»æ€ä½†ä¸çŸ¥æ—¶é—´
                        </li>
                        <li class="mobile-instruction">
                            ğŸ“±
                            <span class="highlight">ç‚¹å‡»çº¿è·¯æ ¼å­</span> - æ ‡è®°é‡‘çŒªè¢«å‡»æ€ï¼ˆå¼€å§‹24å°æ—¶å€’è®¡æ—¶ï¼‰
                        </li>
                        <li class="mobile-instruction">
                            ğŸ‘†
                            <span class="highlight">å¿«é€Ÿä¸‰è¿å‡»çº¿è·¯æ ¼å­</span> - æ ‡è®°é‡‘çŒªè¢«å‡»æ€ä½†ä¸çŸ¥æ—¶é—´
                        </li>
                        <li>
                            ğŸ”„
                            <span class="highlight">åŒå‡»çº¢è‰²/æ©™è‰²æ ¼å­</span> - å–æ¶ˆå‡»æ€çŠ¶æ€å’Œå€’è®¡æ—¶
                        </li>
                        <li>
                            ğŸ”„
                            å€’è®¡æ—¶ç»“æŸåçº¿è·¯è‡ªåŠ¨å˜ä¸º<span class="highlight">ç»¿è‰²</span>å¯ç”¨çŠ¶æ€
                        </li>
                        <li>
                            ğŸ’¾
                            æ‰€æœ‰æ•°æ®è‡ªåŠ¨ä¿å­˜åœ¨æµè§ˆå™¨ä¸­ï¼Œå…³é—­æµè§ˆå™¨åä»å¯æ¢å¤
                        </li>
                        <li>
                            ğŸ•
                            é‡æ–°æ‰“å¼€æµè§ˆå™¨æ—¶è‡ªåŠ¨æ¢å¤å€’è®¡æ—¶
                        </li>
                        <li>
                            â°
                            <span class="highlight">"åªé‡ç½®å€’è®¡æ—¶çŠ¶æ€"</span> - æ¸…é™¤æ‰€æœ‰çº¿è·¯æ ‡è®°ä½†ä¿ç•™å†å²ç»Ÿè®¡
                        </li>
                    </ul>
                </div>
                
                <div class="status-info">
                    <div class="panel-title">
                        ğŸ¨
                        <h2>çŠ¶æ€è¯´æ˜</h2>
                    </div>
                    <div class="status-item">
                        <div class="status-color status-1"></div>
                        <div>æœªå‡»æ€/å¯ç”¨çº¿è·¯</div>
                    </div>
                    <div class="status-item">
                        <div class="status-color status-2"></div>
                        <div>é‡‘çŒªå·²è¢«å‡»æ€ï¼ˆå€’è®¡æ—¶ä¸­ï¼‰</div>
                    </div>
                    <div class="status-item">
                        <div class="status-color status-5"></div>
                        <div>é‡‘çŒªå·²è¢«å‡»æ€ï¼ˆæ—¶é—´æœªçŸ¥ï¼‰</div>
                    </div>
                    <div class="status-item">
                        <div class="status-color status-3"></div>
                        <div>é‡‘çŒªå·²åˆ·æ–°ï¼ˆå¯å†æ¬¡å‡»æ€ï¼‰</div>
                    </div>
                </div>
                
                <button class="action-btn reset" onclick="resetAll()">
                    ğŸ”„ é‡ç½®æ‰€æœ‰çŠ¶æ€
                </button>
                
                <button class="action-btn reset-timers" onclick="resetTimersOnly()">
                    â° åªé‡ç½®å€’è®¡æ—¶çŠ¶æ€
                </button>
                
                <button class="action-btn" onclick="toggleTestMode()" id="test-mode-btn">
                    ğŸ”¬ å¼€å¯æµ‹è¯•æ¨¡å¼ï¼ˆ10ç§’å€’è®¡æ—¶ï¼‰
                </button>
                
                <button class="action-btn collaboration" onclick="showCollaboration()">
                    ğŸ¤ å¤šäººåä½œ
                </button>
                
                <button class="action-btn" onclick="window.goldPigApp.uiManager.showDataManagementDialog()">
                    ğŸ“ æ•°æ®ç®¡ç†
                </button>
                
                <div class="notes-container">
                    <label for="notes-input" class="notes-label">
                        ğŸ“ å¤‡æ³¨è®°å½•
                    </label>
                    <textarea 
                        id="notes-input" 
                        class="notes-input"
                        placeholder="åœ¨è¿™é‡Œè®°å½•ä¸€äº›å¤‡æ³¨ä¿¡æ¯..."
                    ></textarea>
                </div>
            </div>
            
            <div class="flex-container">
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">é‡‘çŒªå‡»æ€ç»Ÿè®¡</div>
                        <div class="chart-tabs">
                            <div class="chart-tab active" data-chart="daily">æ¯æ—¥å‡»æ€</div>
                            <div class="chart-tab" data-chart="total">æ€»å‡»æ€</div>
                            <div class="chart-tab" data-chart="hourly">å‡»æ€æ—¶æ®µ</div>
                        </div>
                    </div>
                    <div class="chart-box">
                        <canvas id="stats-chart" width="800" height="300" style="width: 100%; height: 300px; background: rgba(0,0,0,0.1); border-radius: 8px;"></canvas>
                    </div>
                </div>
                
                <div class="stats">
                    <div class="panel-title">
                        ğŸ“Š
                        <h2>çŠ¶æ€ç»Ÿè®¡</h2>
                    </div>
                    
                    <div class="stat-cards">
                        <div class="stat-card">
                            <div class="stat-label">æ€»çº¿è·¯æ•°</div>
                            <div class="stat-value" id="total-lines">400</div>
                            <div class="stat-label">å½“å‰å¯ç”¨çº¿è·¯</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">å·²å‡»æ€é‡‘çŒª</div>
                            <div class="stat-value" id="killed-count">0</div>
                            <div class="stat-label">å€’è®¡æ—¶ä¸­</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">å‡»æ€æœªçŸ¥æ—¶é—´</div>
                            <div class="stat-value" id="killed-unknown-count">0</div>
                            <div class="stat-label">æ—¶é—´æœªçŸ¥</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">å·²åˆ·æ–°çº¿è·¯</div>
                            <div class="stat-value" id="refreshed-count">0</div>
                            <div class="stat-label">å¯å†æ¬¡å‡»æ€</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">å¯ç”¨çº¿è·¯</div>
                            <div class="stat-value" id="available-count">400</div>
                            <div class="stat-label">æœªå‡»æ€çŠ¶æ€</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">ä»Šæ—¥å‡»æ€</div>
                        <div class="stat-value" id="today-count">0</div>
                        <div class="stat-label">æœ€å24å°æ—¶</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <div class="scroll-hint">
                â¬…ï¸ å‘å·¦æ»‘åŠ¨æŸ¥çœ‹æ›´å¤šçº¿è·¯ â¡ï¸
            </div>
            <table id="line-table">
                <tr>
                    <th>A</th><th>B</th><th>C</th><th>D</th><th>E</th><th>F</th><th>G</th><th>H</th>
                    <th>I</th><th>J</th><th>K</th><th>L</th><th>M</th><th>N</th><th>O</th><th>P</th>
                    <th>Q</th><th>R</th><th>S</th><th>T</th>
                </tr>
            </table>
        </div>
        
        <footer>
            <p>ğŸ”„ ç³»ç»ŸçŠ¶æ€ï¼š<span id="status">è¿è¡Œä¸­</span> | æœ€åæ›´æ–°ï¼š<span id="last-update">--:--:--</span></p>
            <p>âš ï¸ æç¤ºï¼šæ•°æ®å­˜å‚¨åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œå…³é—­æµè§ˆå™¨åé‡æ–°æ‰“å¼€ä¼šæ¢å¤å€’è®¡æ—¶</p>
            <p>ğŸ‘¤ åˆ¶ä½œäººï¼š<span class="highlight">Mikogo</span> | ğŸ’¬ è”ç³»QQï¼š<span class="highlight">1013859513</span></p>
        </footer>
    </div>

    
    <!-- æ‰‹æœºç«¯æ“ä½œæç¤º -->
    <div class="mobile-hint">
        ç‚¹å‡»æ ¼å­æ ‡è®°å‡»æ€ï¼Œä¸‰è¿å‡»æ ‡è®°ä¸çŸ¥æ—¶é—´
    </div>

    <!-- è°ƒè¯•ä¿¡æ¯ -->
    <div style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; z-index: 1000; font-size: 12px;">
        <div>è¡¨æ ¼çŠ¶æ€: <span id="debug-table-status">æ£€æŸ¥ä¸­...</span></div>
        <div>å•å…ƒæ ¼æ•°: <span id="debug-cell-count">0</span></div>
    </div>

    <!-- ä¸»åº”ç”¨æ¨¡å—è„šæœ¬ -->
    <script type="module" src="js/app.js"></script>
    
    <!-- è¡¨æ ¼ç”Ÿæˆå¤‡ç”¨è„šæœ¬ -->
    <script>
        // å¤‡ç”¨è¡¨æ ¼ç”Ÿæˆå™¨ - å¦‚æœæ¨¡å—åŠ è½½å¤±è´¥åˆ™ä½¿ç”¨æ­¤æ–¹æ³•
        function generateTableFallback() {
            console.log('ä½¿ç”¨å¤‡ç”¨è¡¨æ ¼ç”Ÿæˆå™¨');
            const table = document.getElementById('line-table');
            if (!table) return;
            
            const existingCells = table.querySelectorAll('td[data-line]');
            console.log(`ç°æœ‰å•å…ƒæ ¼: ${existingCells.length}`);
            
            if (existingCells.length >= 400) {
                console.log('è¡¨æ ¼å·²å®Œæ•´');
                return;
            }
            
            // ä¸ºç°æœ‰å•å…ƒæ ¼ç»‘å®šåŸºæœ¬äº‹ä»¶
            existingCells.forEach(cell => {
                if (!cell.onclick) {
                    cell.addEventListener('click', function() {
                        // å°è¯•ä½¿ç”¨ä¸»åº”ç”¨çš„äº‹ä»¶å¤„ç†å™¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨å¤‡ç”¨æ–¹å¼
                        if (window.goldPigApp && window.goldPigApp.eventManager) {
                            const mockEvent = { currentTarget: this };
                            window.goldPigApp.eventManager.handleCellClick(mockEvent);
                        } else {
                            handleCellClickFallback(this);
                        }
                    });
                    
                    cell.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        if (window.goldPigApp && window.goldPigApp.eventManager) {
                            const mockEvent = { currentTarget: this, preventDefault: () => {} };
                            window.goldPigApp.eventManager.handleCellRightClick(mockEvent);
                        } else {
                            handleCellRightClickFallback(this);
                        }
                    });
                    
                    cell.addEventListener('dblclick', function() {
                        if (window.goldPigApp && window.goldPigApp.eventManager) {
                            const mockEvent = { currentTarget: this };
                            window.goldPigApp.eventManager.handleCellDoubleClick(mockEvent);
                        } else {
                            handleCellDoubleClickFallback(this);
                        }
                    });
                }
            });
            
            // ç”Ÿæˆå‰©ä½™çš„å•å…ƒæ ¼
            let lineNumber = existingCells.length + 1;
            let currentRow = existingCells.length > 0 ? existingCells[existingCells.length - 1].parentElement : null;
            let cellsInCurrentRow = currentRow ? currentRow.children.length : 0;
            
            for (let i = lineNumber; i <= 400; i++) {
                // å¦‚æœéœ€è¦æ–°è¡Œ
                if (!currentRow || cellsInCurrentRow >= 20) {
                    currentRow = document.createElement('tr');
                    table.appendChild(currentRow);
                    cellsInCurrentRow = 0;
                }
                
                const cell = document.createElement('td');
                cell.textContent = i;
                cell.dataset.line = i;
                
                // æ·»åŠ å®šæ—¶å™¨æ˜¾ç¤ºå…ƒç´ 
                const timerDisplay = document.createElement('div');
                timerDisplay.id = `timer-${i}`;
                timerDisplay.className = 'timer-display';
                cell.appendChild(timerDisplay);
                
                // ç»‘å®šäº‹ä»¶
                cell.addEventListener('click', function() {
                    // å°è¯•ä½¿ç”¨ä¸»åº”ç”¨çš„äº‹ä»¶å¤„ç†å™¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨å¤‡ç”¨æ–¹å¼
                    if (window.goldPigApp && window.goldPigApp.eventManager) {
                        // åˆ›å»ºæ¨¡æ‹Ÿäº‹ä»¶
                        const mockEvent = { currentTarget: this };
                        window.goldPigApp.eventManager.handleCellClick(mockEvent);
                    } else {
                        // å¤‡ç”¨å¤„ç†æ–¹å¼
                        handleCellClickFallback(this);
                    }
                });
                
                cell.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    // å°è¯•ä½¿ç”¨ä¸»åº”ç”¨çš„äº‹ä»¶å¤„ç†å™¨
                    if (window.goldPigApp && window.goldPigApp.eventManager) {
                        const mockEvent = { currentTarget: this, preventDefault: () => {} };
                        window.goldPigApp.eventManager.handleCellRightClick(mockEvent);
                    } else {
                        // å¤‡ç”¨å¤„ç†æ–¹å¼
                        handleCellRightClickFallback(this);
                    }
                });
                
                cell.addEventListener('dblclick', function() {
                    // å°è¯•ä½¿ç”¨ä¸»åº”ç”¨çš„äº‹ä»¶å¤„ç†å™¨
                    if (window.goldPigApp && window.goldPigApp.eventManager) {
                        const mockEvent = { currentTarget: this };
                        window.goldPigApp.eventManager.handleCellDoubleClick(mockEvent);
                    } else {
                        // å¤‡ç”¨å¤„ç†æ–¹å¼
                        handleCellDoubleClickFallback(this);
                    }
                });
                
                currentRow.appendChild(cell);
                cellsInCurrentRow++;
            }
            
            const finalCells = table.querySelectorAll('td[data-line]');
            console.log(`å¤‡ç”¨ç”Ÿæˆå™¨å®Œæˆï¼Œæ€»å…± ${finalCells.length} ä¸ªå•å…ƒæ ¼`);
            
            // æ›´æ–°è°ƒè¯•ä¿¡æ¯
            const debugCellCount = document.getElementById('debug-cell-count');
            if (debugCellCount) {
                debugCellCount.textContent = finalCells.length;
            }
            
            const debugTableStatus = document.getElementById('debug-table-status');
            if (debugTableStatus) {
                debugTableStatus.textContent = finalCells.length === 400 ? 'âœ… æ­£å¸¸' : `âš ï¸ ä¸å®Œæ•´(${finalCells.length})`;
            }
        }
        
        // å¤‡ç”¨äº‹ä»¶å¤„ç†å‡½æ•° - ä¼˜å…ˆä½¿ç”¨modulesä¸­çš„æ–¹æ³•
        function handleCellClickFallback(cell) {
            const lineNumber = cell.dataset.line;
            console.log('å¤‡ç”¨å¤„ç†-ç‚¹å‡»å•å…ƒæ ¼:', lineNumber);
            
            // ä¼˜å…ˆä½¿ç”¨ä¸»åº”ç”¨çš„å®Œæ•´äº‹ä»¶å¤„ç†
            if (window.goldPigApp && window.goldPigApp.eventManager) {
                const mockEvent = { currentTarget: cell };
                window.goldPigApp.eventManager.handleCellClick(mockEvent);
                return;
            }
            
            // å¦‚æœå·²ç»æ˜¯å‡»æ€çŠ¶æ€ï¼Œåˆ™å¿½ç•¥
            if (cell.classList.contains('killed') || cell.classList.contains('killed-unknown')) {
                return;
            }
            
            // ç§»é™¤åˆ·æ–°çŠ¶æ€
            if (cell.classList.contains('refreshed')) {
                cell.classList.remove('refreshed');
            }
            
            // æ·»åŠ å‡»æ€çŠ¶æ€
            cell.classList.add('killed');
            
            // è®°å½•å‡»æ€æ—¶é—´å’ŒçŠ¶æ€
            const killTime = new Date().getTime();
            localStorage.setItem(`pigTimer_line-${lineNumber}`, 'killed');
            localStorage.setItem(`pigTimer_killTime-${lineNumber}`, killTime);
            
            // è®°å½•å‡»æ€äº‹ä»¶ - ä½¿ç”¨statsManagerçš„æ ¼å¼
            recordKillEventFallback(lineNumber, killTime);
            
            // å¼€å§‹å€’è®¡æ—¶ - ä¼˜å…ˆä½¿ç”¨timerManager
            if (window.goldPigApp && window.goldPigApp.timerManager) {
                window.goldPigApp.timerManager.startTimer(lineNumber, killTime, null, cell, (ln) => {
                    handleTimerCompleteFallback(ln, cell);
                });
            } else {
                startTimerFallback(lineNumber, killTime, cell);
            }
            
            // æ›´æ–°ç»Ÿè®¡
            updateStatsFallback();
        }
        
        function handleCellRightClickFallback(cell) {
            const lineNumber = cell.dataset.line;
            console.log('å¤‡ç”¨å¤„ç†-å³å‡»å•å…ƒæ ¼:', lineNumber);
            
            // ä¼˜å…ˆä½¿ç”¨ä¸»åº”ç”¨çš„å®Œæ•´äº‹ä»¶å¤„ç†
            if (window.goldPigApp && window.goldPigApp.eventManager) {
                const mockEvent = { currentTarget: cell, preventDefault: () => {} };
                window.goldPigApp.eventManager.handleCellRightClick(mockEvent);
                return;
            }
            
            // å¦‚æœå·²ç»æ˜¯å‡»æ€çŠ¶æ€ï¼Œåˆ™å¿½ç•¥
            if (cell.classList.contains('killed') || cell.classList.contains('killed-unknown')) {
                return;
            }
            
            // ç§»é™¤åˆ·æ–°çŠ¶æ€
            if (cell.classList.contains('refreshed')) {
                cell.classList.remove('refreshed');
            }
            
            // æ·»åŠ å‡»æ€æœªçŸ¥çŠ¶æ€
            cell.classList.add('killed-unknown');
            
            // è®°å½•çŠ¶æ€ï¼ˆä¸è®°å½•æ—¶é—´ï¼‰
            localStorage.setItem(`pigTimer_line-${lineNumber}`, 'killed-unknown');
            
            // è®°å½•å‡»æ€äº‹ä»¶
            const killTime = new Date().getTime();
            recordKillEventFallback(lineNumber, killTime);
            
            // æ›´æ–°ç»Ÿè®¡
            updateStatsFallback();
        }
        
        function handleCellDoubleClickFallback(cell) {
            const lineNumber = cell.dataset.line;
            console.log('å¤‡ç”¨å¤„ç†-åŒå‡»å•å…ƒæ ¼:', lineNumber);
            
            // ä¼˜å…ˆä½¿ç”¨ä¸»åº”ç”¨çš„å®Œæ•´äº‹ä»¶å¤„ç†
            if (window.goldPigApp && window.goldPigApp.eventManager) {
                const mockEvent = { currentTarget: cell };
                window.goldPigApp.eventManager.handleCellDoubleClick(mockEvent);
                return;
            }
            
            // ç§»é™¤æ‰€æœ‰çŠ¶æ€
            cell.classList.remove('killed', 'killed-unknown', 'refreshed');
            
            // æ¸…é™¤è®¡æ—¶å™¨
            const timerDisplay = document.getElementById(`timer-${lineNumber}`);
            if (timerDisplay) {
                timerDisplay.textContent = '';
            }
            
            // æ¸…é™¤å­˜å‚¨ - ä½¿ç”¨storageManagerçš„æ–¹æ³•æˆ–ç›´æ¥æ¸…é™¤
            let killTime = null;
            if (window.goldPigApp && window.goldPigApp.storageManager) {
                killTime = window.goldPigApp.storageManager.getKillTime(lineNumber);
                window.goldPigApp.storageManager.removeLineState(lineNumber);
                window.goldPigApp.storageManager.removeKillTime(lineNumber);
            } else {
                killTime = localStorage.getItem(`pigTimer_killTime-${lineNumber}`);
                if (killTime) killTime = parseInt(killTime);
                localStorage.removeItem(`pigTimer_line-${lineNumber}`);
                localStorage.removeItem(`pigTimer_killTime-${lineNumber}`);
            }
            
            // ä»å‡»æ€äº‹ä»¶ä¸­ç§»é™¤ - ä¼˜å…ˆä½¿ç”¨statsManager
            if (window.goldPigApp && window.goldPigApp.statsManager) {
                window.goldPigApp.statsManager.removeKillEvent(lineNumber, killTime);
            } else {
                // å¤‡ç”¨ç§»é™¤å‡»æ€äº‹ä»¶
                removeKillEventFallback(lineNumber, killTime);
            }
            
            // åœæ­¢å€’è®¡æ—¶ - ä¼˜å…ˆä½¿ç”¨timerManager
            if (window.goldPigApp && window.goldPigApp.timerManager) {
                window.goldPigApp.timerManager.clearTimer(lineNumber);
            } else if (window.fallbackTimers && window.fallbackTimers[lineNumber]) {
                clearInterval(window.fallbackTimers[lineNumber]);
                delete window.fallbackTimers[lineNumber];
            }
            
            // æ›´æ–°ç»Ÿè®¡
            updateStatsFallback();
        }
        
        // å¤‡ç”¨å€’è®¡æ—¶å‡½æ•° - ä¼˜å…ˆä½¿ç”¨timerManager
        function startTimerFallback(lineNumber, killTime, cell) {
            // å¦‚æœä¸»åº”ç”¨çš„timerManagerå¯ç”¨ï¼Œä½¿ç”¨å®ƒ
            if (window.goldPigApp && window.goldPigApp.timerManager) {
                window.goldPigApp.timerManager.startTimer(lineNumber, killTime, null, cell, (ln) => {
                    handleTimerCompleteFallback(ln, cell);
                });
                return;
            }
            
            // å¤‡ç”¨å€’è®¡æ—¶å®ç°
            if (!window.fallbackTimers) {
                window.fallbackTimers = {};
            }
            
            // å¦‚æœå·²æœ‰å€’è®¡æ—¶ï¼Œå…ˆæ¸…é™¤
            if (window.fallbackTimers[lineNumber]) {
                clearInterval(window.fallbackTimers[lineNumber]);
            }
            
            const timerDisplay = document.getElementById(`timer-${lineNumber}`);
            if (!timerDisplay) return;
            
            // æ£€æŸ¥æµ‹è¯•æ¨¡å¼
            const testMode = localStorage.getItem('pigTimer_testMode') === 'true';
            const timerDuration = testMode ? 10000 : (24 * 60 * 60 * 1000); // 10ç§’æˆ–24å°æ—¶
            
            window.fallbackTimers[lineNumber] = setInterval(() => {
                const currentTime = new Date().getTime();
                const elapsed = currentTime - killTime;
                const remaining = timerDuration - elapsed;
                
                if (remaining <= 0) {
                    // å€’è®¡æ—¶ç»“æŸ
                    clearInterval(window.fallbackTimers[lineNumber]);
                    delete window.fallbackTimers[lineNumber];
                    
                    handleTimerCompleteFallback(lineNumber, cell);
                } else {
                    // æ˜¾ç¤ºå‰©ä½™æ—¶é—´
                    const hours = Math.floor(remaining / (60 * 60 * 1000));
                    const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
                    const seconds = Math.floor((remaining % (60 * 1000)) / 1000);
                    
                    if (testMode) {
                        timerDisplay.textContent = `${seconds}s`;
                    } else {
                        timerDisplay.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                }
            }, 1000);
        }
        
        // å¤‡ç”¨å€’è®¡æ—¶å®Œæˆå¤„ç†
        function handleTimerCompleteFallback(lineNumber, cell) {
            // ä¼˜å…ˆä½¿ç”¨tableManagerè®¾ç½®åˆ·æ–°çŠ¶æ€
            if (window.goldPigApp && window.goldPigApp.tableManager) {
                window.goldPigApp.tableManager.setCellRefreshed(cell, lineNumber);
            } else {
                // å¤‡ç”¨è®¾ç½®åˆ·æ–°çŠ¶æ€
                cell.classList.remove('killed');
                cell.classList.add('refreshed');
                const timerDisplay = document.getElementById(`timer-${lineNumber}`);
                if (timerDisplay) {
                    timerDisplay.textContent = '';
                }
            }
            
            // ä¼˜å…ˆä½¿ç”¨storageManageræ›´æ–°çŠ¶æ€
            if (window.goldPigApp && window.goldPigApp.storageManager) {
                window.goldPigApp.storageManager.setLineState(lineNumber, 'refreshed');
                window.goldPigApp.storageManager.removeKillTime(lineNumber);
            } else {
                localStorage.setItem(`pigTimer_line-${lineNumber}`, 'refreshed');
                localStorage.removeItem(`pigTimer_killTime-${lineNumber}`);
            }
            
            // ä¼˜å…ˆä½¿ç”¨uiManageræ˜¾ç¤ºåˆ·æ–°çŠ¶æ€
            if (window.goldPigApp && window.goldPigApp.uiManager) {
                window.goldPigApp.uiManager.showRefreshStatus(lineNumber);
            }
            
            // æ›´æ–°ç»Ÿè®¡
            updateStatsFallback();
        }
        
        // å¤‡ç”¨å‡»æ€äº‹ä»¶è®°å½• - ä¼˜å…ˆä½¿ç”¨statsManager
        function recordKillEventFallback(lineNumber, killTime) {
            if (window.goldPigApp && window.goldPigApp.statsManager) {
                window.goldPigApp.statsManager.recordKillEvent(lineNumber, killTime);
                return;
            }
            
            // å¤‡ç”¨è®°å½•æ–¹å¼ - ä½¿ç”¨ä¸statsManagerç›¸åŒçš„æ ¼å¼
            let killEvents = [];
            try {
                const stored = localStorage.getItem('killEvents');
                if (stored) {
                    killEvents = JSON.parse(stored);
                }
            } catch (e) {
                console.warn('è§£æå‡»æ€äº‹ä»¶è®°å½•å¤±è´¥:', e);
                killEvents = [];
            }
            
            // æ·»åŠ æ–°çš„å‡»æ€äº‹ä»¶ - ä½¿ç”¨ä¸statsManagerç›¸åŒçš„æ ¼å¼
            const killEvent = {
                line: parseInt(lineNumber),
                timestamp: killTime
            };
            
            killEvents.push(killEvent);
            
            // ä¿å­˜æ›´æ–°åçš„è®°å½•
            try {
                localStorage.setItem('killEvents', JSON.stringify(killEvents));
                console.log('å¤‡ç”¨è®°å½•å‡»æ€äº‹ä»¶:', killEvent);
            } catch (e) {
                console.error('ä¿å­˜å‡»æ€äº‹ä»¶å¤±è´¥:', e);
            }
        }
        
        // å¤‡ç”¨ç§»é™¤å‡»æ€äº‹ä»¶å‡½æ•°
        function removeKillEventFallback(lineNumber, killTime) {
            try {
                const stored = localStorage.getItem('killEvents');
                if (!stored) return;
                
                let killEvents = JSON.parse(stored);
                const originalLength = killEvents.length;
                
                if (killTime) {
                    // æœ‰å‡»æ€æ—¶é—´æ—¶ï¼Œç²¾ç¡®åŒ¹é… - ä½¿ç”¨ä¸statsManagerç›¸åŒçš„é€»è¾‘
                    killEvents = killEvents.filter(event => 
                        !(event.line == lineNumber && Math.abs(event.timestamp - killTime) < 1000)
                    );
                } else {
                    // æ²¡æœ‰å‡»æ€æ—¶é—´æ—¶ï¼Œç§»é™¤è¯¥çº¿è·¯çš„æœ€è¿‘ä¸€æ¬¡å‡»æ€è®°å½•
                    for (let i = killEvents.length - 1; i >= 0; i--) {
                        if (killEvents[i].line == lineNumber) {
                            killEvents.splice(i, 1);
                            break;
                        }
                    }
                }
                
                // åªæœ‰æˆåŠŸç§»é™¤äº‹ä»¶æ—¶æ‰æ›´æ–°å­˜å‚¨
                if (killEvents.length < originalLength) {
                    localStorage.setItem('killEvents', JSON.stringify(killEvents));
                    console.log(`å¤‡ç”¨ç§»é™¤çº¿è·¯ ${lineNumber} çš„å‡»æ€è®°å½•${killTime ? ', å‡»æ€æ—¶é—´: ' + new Date(killTime) : ' (æœ€è¿‘ä¸€æ¬¡)'}`);
                } else {
                    console.warn(`å¤‡ç”¨ç³»ç»Ÿæœªæ‰¾åˆ°çº¿è·¯ ${lineNumber} çš„å‡»æ€è®°å½•${killTime ? ', å‡»æ€æ—¶é—´: ' + new Date(killTime) : ''}`);
                }
            } catch (e) {
                console.error('å¤‡ç”¨ç§»é™¤å‡»æ€äº‹ä»¶å¤±è´¥:', e);
            }
        }
        
        // å¤‡ç”¨ç»Ÿè®¡æ›´æ–°å‡½æ•° - ä¼˜å…ˆä½¿ç”¨statsManager
        function updateStatsFallback() {
            // ä¼˜å…ˆä½¿ç”¨ä¸»åº”ç”¨çš„statsManager
            if (window.goldPigApp && window.goldPigApp.statsManager) {
                window.goldPigApp.statsManager.updateStats();
                return;
            }
            
            // å¤‡ç”¨ç»Ÿè®¡æ›´æ–°
            let killedCount = 0;
            let killedUnknownCount = 0;
            let refreshedCount = 0;
            let availableCount = 0;
            
            const cells = document.querySelectorAll('td[data-line]');
            cells.forEach(cell => {
                if (cell.classList.contains('killed')) {
                    killedCount++;
                } else if (cell.classList.contains('killed-unknown')) {
                    killedUnknownCount++;
                } else if (cell.classList.contains('refreshed')) {
                    refreshedCount++;
                } else {
                    availableCount++;
                }
            });
            
            // è®¡ç®—ä»Šæ—¥å‡»æ€æ•°é‡
            const todayCount = getTodayKillCountFallback();
            
            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            const elements = {
                'killed-count': killedCount,
                'killed-unknown-count': killedUnknownCount,
                'refreshed-count': refreshedCount,
                'available-count': availableCount,
                'total-lines': cells.length,
                'today-count': todayCount
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
            
            console.log('å¤‡ç”¨ç»Ÿè®¡æ›´æ–°:', elements);
        }
        
        // å…¨å±€é‡ç½®å‡½æ•° - ä¼˜å…ˆä½¿ç”¨ä¸»åº”ç”¨çš„æ–¹æ³•
        function resetAll() {
            console.log('æ‰§è¡Œå…¨å±€é‡ç½®');
            
            // ä¼˜å…ˆä½¿ç”¨ä¸»åº”ç”¨çš„é‡ç½®æ–¹æ³•
            if (window.goldPigApp) {
                if (window.goldPigApp.uiManager && !window.goldPigApp.uiManager.showConfirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰çº¿è·¯çŠ¶æ€å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰å€’è®¡æ—¶å’Œæ ‡è®°çŠ¶æ€ï¼')) {
                    return;
                }
                
                if (window.goldPigApp.timerManager) {
                    window.goldPigApp.timerManager.clearAllTimers();
                }
                
                if (window.goldPigApp.storageManager) {
                    window.goldPigApp.storageManager.resetAllData();
                }
                
                if (window.goldPigApp.statsManager) {
                    window.goldPigApp.statsManager.resetAllKillEvents();
                }
                
                if (window.goldPigApp.tableManager) {
                    window.goldPigApp.tableManager.resetAllCells();
                }
                
                if (window.goldPigApp.uiManager) {
                    window.goldPigApp.uiManager.showResetStatus('all');
                }
                
                if (window.goldPigApp.updateStats) {
                    window.goldPigApp.updateStats();
                }
                
                return;
            }
            
            // å¤‡ç”¨é‡ç½®æ–¹å¼
            if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰çº¿è·¯çŠ¶æ€å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰å€’è®¡æ—¶å’Œæ ‡è®°çŠ¶æ€ï¼')) {
                return;
            }
            
            const cells = document.querySelectorAll('td[data-line]');
            cells.forEach(cell => {
                cell.classList.remove('killed', 'killed-unknown', 'refreshed');
                const timer = cell.querySelector('.timer-display');
                if (timer) timer.textContent = '';
            });
            
            // æ¸…é™¤æ‰€æœ‰å€’è®¡æ—¶
            if (window.fallbackTimers) {
                Object.values(window.fallbackTimers).forEach(timerId => clearInterval(timerId));
                window.fallbackTimers = {};
            }
            
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨
            for (let i = 1; i <= 400; i++) {
                localStorage.removeItem(`pigTimer_line-${i}`);
                localStorage.removeItem(`pigTimer_killTime-${i}`);
            }
            
            // æ¸…é™¤å‡»æ€äº‹ä»¶
            localStorage.removeItem('killEvents');
            
            // æ›´æ–°ç»Ÿè®¡
            updateStatsFallback();
            
            console.log('é‡ç½®å®Œæˆ');
        }
        
        // ä»…é‡ç½®å€’è®¡æ—¶çŠ¶æ€å‡½æ•° - ä¼˜å…ˆä½¿ç”¨ä¸»åº”ç”¨çš„æ–¹æ³•
        function resetTimersOnly() {
            console.log('æ‰§è¡Œä»…é‡ç½®å€’è®¡æ—¶');
            
            // ä¼˜å…ˆä½¿ç”¨ä¸»åº”ç”¨çš„é‡ç½®æ–¹æ³•
            if (window.goldPigApp) {
                if (window.goldPigApp.uiManager && !window.goldPigApp.uiManager.showConfirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å€’è®¡æ—¶çŠ¶æ€å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰çº¿è·¯çš„å‡»æ€æ ‡è®°ï¼Œä½†ä¿ç•™å†å²ç»Ÿè®¡æ•°æ®ï¼')) {
                    return;
                }
                
                if (window.goldPigApp.timerManager) {
                    window.goldPigApp.timerManager.clearAllTimers();
                }
                
                if (window.goldPigApp.storageManager) {
                    window.goldPigApp.storageManager.resetAllLineStates();
                }
                
                if (window.goldPigApp.tableManager) {
                    window.goldPigApp.tableManager.resetAllCells();
                }
                
                if (window.goldPigApp.uiManager) {
                    window.goldPigApp.uiManager.showResetStatus('timers');
                }
                
                if (window.goldPigApp.updateStats) {
                    window.goldPigApp.updateStats();
                }
                
                return;
            }
            
            // å¤‡ç”¨é‡ç½®æ–¹å¼
            if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å€’è®¡æ—¶çŠ¶æ€å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰çº¿è·¯çš„å‡»æ€æ ‡è®°ï¼Œä½†ä¿ç•™å†å²ç»Ÿè®¡æ•°æ®ï¼')) {
                return;
            }
            
            const cells = document.querySelectorAll('td[data-line]');
            cells.forEach(cell => {
                cell.classList.remove('killed', 'killed-unknown', 'refreshed');
                const timer = cell.querySelector('.timer-display');
                if (timer) timer.textContent = '';
            });
            
            // æ¸…é™¤æ‰€æœ‰å€’è®¡æ—¶
            if (window.fallbackTimers) {
                Object.values(window.fallbackTimers).forEach(timerId => clearInterval(timerId));
                window.fallbackTimers = {};
            }
            
            // æ¸…é™¤å€’è®¡æ—¶å­˜å‚¨ä½†ä¿ç•™å†å²
            for (let i = 1; i <= 400; i++) {
                localStorage.removeItem(`pigTimer_line-${i}`);
                localStorage.removeItem(`pigTimer_killTime-${i}`);
            }
            
            // æ›´æ–°ç»Ÿè®¡
            updateStatsFallback();
            
            console.log('å€’è®¡æ—¶é‡ç½®å®Œæˆ');
        }
        
        // æµ‹è¯•æ¨¡å¼åˆ‡æ¢å‡½æ•° - ä¼˜å…ˆä½¿ç”¨ä¸»åº”ç”¨çš„æ–¹æ³•
        function toggleTestMode() {
            console.log('åˆ‡æ¢æµ‹è¯•æ¨¡å¼');
            
            // ä¼˜å…ˆä½¿ç”¨ä¸»åº”ç”¨çš„æµ‹è¯•æ¨¡å¼åˆ‡æ¢
            if (window.goldPigApp && typeof window.toggleTestMode === 'function') {
                window.toggleTestMode();
                return;
            }
            
            // å¤‡ç”¨æµ‹è¯•æ¨¡å¼åˆ‡æ¢
            const currentMode = localStorage.getItem('pigTimer_testMode') === 'true';
            const newMode = !currentMode;
            localStorage.setItem('pigTimer_testMode', newMode);
            
            const btn = document.getElementById('test-mode-btn');
            if (btn) {
                btn.textContent = newMode ? 'ğŸ”¬ å…³é—­æµ‹è¯•æ¨¡å¼' : 'ğŸ”¬ å¼€å¯æµ‹è¯•æ¨¡å¼ï¼ˆ10ç§’å€’è®¡æ—¶ï¼‰';
            }
            
            console.log('æµ‹è¯•æ¨¡å¼:', newMode ? 'å¼€å¯' : 'å…³é—­');
        }
        
        // è·å–ä»Šæ—¥å‡»æ€æ•°é‡ - ä¼˜å…ˆä½¿ç”¨statsManager
        function getTodayKillCountFallback() {
            // ä¼˜å…ˆä½¿ç”¨ä¸»åº”ç”¨çš„statsManager
            if (window.goldPigApp && window.goldPigApp.statsManager) {
                // ç›´æ¥è°ƒç”¨statsManagerçš„æ›´æ–°æ–¹æ³•ï¼Œå®ƒä¼šè‡ªåŠ¨è®¡ç®—ä»Šæ—¥å‡»æ€
                return 0; // è®©statsManagerå¤„ç†
            }
            
            try {
                const stored = localStorage.getItem('killEvents');
                if (!stored) return 0;
                
                const killEvents = JSON.parse(stored);
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                const todayEnd = todayStart + 24 * 60 * 60 * 1000;
                
                // ç»Ÿè®¡ä»Šå¤©çš„å‡»æ€æ•°é‡ - ä½¿ç”¨ä¸statsManagerç›¸åŒçš„ç®—æ³•
                const todayKills = killEvents.filter(event => {
                    return event.timestamp >= todayStart && event.timestamp < todayEnd;
                });
                
                return todayKills.length;
            } catch (e) {
                console.warn('è·å–ä»Šæ—¥å‡»æ€æ•°é‡å¤±è´¥:', e);
                return 0;
            }
        }
        
        // å»¶è¿Ÿæ£€æŸ¥å¹¶åœ¨éœ€è¦æ—¶ä½¿ç”¨å¤‡ç”¨ç”Ÿæˆå™¨
        setTimeout(() => {
            const table = document.getElementById('line-table');
            const cells = table ? table.querySelectorAll('td[data-line]') : [];
            
            console.log(`æ£€æŸ¥è¡¨æ ¼çŠ¶æ€: ${cells.length} ä¸ªå•å…ƒæ ¼`);
            
            if (cells.length < 400) {
                console.log('è¡¨æ ¼ä¸å®Œæ•´ï¼Œä½¿ç”¨å¤‡ç”¨ç”Ÿæˆå™¨');
                generateTableFallback();
                
                // ç”Ÿæˆå®Œæˆåæ¢å¤çŠ¶æ€
                setTimeout(() => {
                    restoreStateFallback();
                }, 500);
            } else {
                console.log('è¡¨æ ¼å·²å®Œæ•´');
                // å¦‚æœè¡¨æ ¼å®Œæ•´ä½†ä¸»åº”ç”¨æœªå·¥ä½œï¼Œæ¢å¤çŠ¶æ€
                setTimeout(() => {
                    if (!window.goldPigApp || !window.goldPigApp.initialized) {
                        console.log('ä¸»åº”ç”¨æœªåˆå§‹åŒ–ï¼Œä½¿ç”¨å¤‡ç”¨çŠ¶æ€æ¢å¤');
                        restoreStateFallback();
                    }
                }, 1000);
            }
            
            // æ£€æŸ¥å›¾è¡¨åŠŸèƒ½
            setTimeout(() => {
                checkChartFunctionality();
            }, 2000);
        }, 3000); // å»¶è¿Ÿ3ç§’æ£€æŸ¥ï¼Œç»™ä¸»åº”ç”¨è¶³å¤Ÿæ—¶é—´åˆå§‹åŒ–
        
        // æ£€æŸ¥å›¾è¡¨åŠŸèƒ½
        function checkChartFunctionality() {
            console.log('æ£€æŸ¥å›¾è¡¨åŠŸèƒ½...');
            
            // æ£€æŸ¥å›¾è¡¨å…ƒç´ æ˜¯å¦å­˜åœ¨
            const canvas = document.getElementById('stats-chart');
            const chartTabs = document.querySelectorAll('.chart-tab');
            
            console.log('Canvaså…ƒç´ :', canvas);
            console.log('å›¾è¡¨æ ‡ç­¾é¡µ:', chartTabs.length);
            
            if (!canvas) {
                console.error('Canvaså…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            if (chartTabs.length === 0) {
                console.error('å›¾è¡¨æ ‡ç­¾é¡µä¸å­˜åœ¨');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰äº‹ä»¶ç»‘å®š
            let hasEvents = false;
            chartTabs.forEach(tab => {
                if (tab.onclick || tab.addEventListener) {
                    hasEvents = true;
                }
            });
            
            // å¦‚æœæ²¡æœ‰äº‹ä»¶ç»‘å®šï¼Œæ·»åŠ å¤‡ç”¨äº‹ä»¶
            if (!hasEvents || (!window.goldPigApp || !window.goldPigApp.initialized)) {
                console.log('æ·»åŠ å¤‡ç”¨å›¾è¡¨äº‹ä»¶ç»‘å®š');
                addFallbackChartEvents();
            }
            
            // æµ‹è¯•å›¾è¡¨ç»˜åˆ¶
            if (typeof window.testChart === 'function') {
                console.log('æµ‹è¯•ä¸»åº”ç”¨å›¾è¡¨åŠŸèƒ½');
                window.testChart();
            } else {
                console.log('ä½¿ç”¨å¤‡ç”¨å›¾è¡¨æµ‹è¯•');
                testChartFallback();
            }
        }
        
        // å¤‡ç”¨å›¾è¡¨äº‹ä»¶ç»‘å®š
        function addFallbackChartEvents() {
            const chartTabs = document.querySelectorAll('.chart-tab');
            
            chartTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    console.log('å¤‡ç”¨å›¾è¡¨æ ‡ç­¾é¡µç‚¹å‡»:', this.dataset.chart);
                    
                    // æ›´æ–°æ´»åŠ¨çŠ¶æ€
                    chartTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // å°è¯•ä½¿ç”¨ä¸»åº”ç”¨çš„å›¾è¡¨åˆ‡æ¢
                    if (typeof window.switchChart === 'function') {
                        window.switchChart(this.dataset.chart);
                    } else {
                        // å¤‡ç”¨å›¾è¡¨æ˜¾ç¤º
                        renderChartFallback(this.dataset.chart);
                    }
                });
            });
            
            console.log('å¤‡ç”¨å›¾è¡¨äº‹ä»¶ç»‘å®šå®Œæˆ');
        }
        
        // å¤‡ç”¨å›¾è¡¨æ¸²æŸ“
        function renderChartFallback(chartType) {
            console.log('å¤‡ç”¨å›¾è¡¨æ¸²æŸ“:', chartType);
            
            const canvas = document.getElementById('stats-chart');
            if (!canvas) {
                console.error('Canvaså…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('æ— æ³•è·å–Canvasä¸Šä¸‹æ–‡');
                return;
            }
            
            try {
                // è®¾ç½®Canvaså°ºå¯¸
                const rect = canvas.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                ctx.scale(dpr, dpr);
                
                // æ¸…é™¤ç”»å¸ƒ
                ctx.clearRect(0, 0, rect.width, rect.height);
                
                // ç»˜åˆ¶ç®€å•çš„å ä½å›¾è¡¨
                ctx.fillStyle = 'rgba(52, 152, 219, 0.2)';
                ctx.fillRect(0, 0, rect.width, rect.height);
                
                ctx.fillStyle = '#f1c40f';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${getChartTitle(chartType)}`, rect.width / 2, rect.height / 2 - 20);
                
                ctx.fillStyle = '#ecf0f1';
                ctx.font = '14px Arial';
                ctx.fillText('å›¾è¡¨åŠŸèƒ½æ­£åœ¨åŠ è½½ä¸­...', rect.width / 2, rect.height / 2 + 20);
                
                // å°è¯•è·å–å®é™…æ•°æ®
                if (window.goldPigApp && window.goldPigApp.statsManager) {
                    try {
                        drawSimpleChart(ctx, rect, chartType, window.goldPigApp.statsManager);
                    } catch (dataError) {
                        console.warn('è·å–å›¾è¡¨æ•°æ®å¤±è´¥:', dataError);
                    }
                }
                
                console.log('å¤‡ç”¨å›¾è¡¨æ¸²æŸ“å®Œæˆ');
            } catch (error) {
                console.error('å¤‡ç”¨å›¾è¡¨æ¸²æŸ“å¤±è´¥:', error);
            }
        }
        
        // è·å–å›¾è¡¨æ ‡é¢˜
        function getChartTitle(chartType) {
            switch (chartType) {
                case 'daily': return 'æ¯æ—¥å‡»æ€è¶‹åŠ¿';
                case 'total': return 'æ€»å‡»æ€ç»Ÿè®¡';
                case 'hourly': return 'å‡»æ€æ—¶æ®µåˆ†æ';
                default: return 'å‡»æ€ç»Ÿè®¡';
            }
        }
        
        // ç»˜åˆ¶ç®€å•å›¾è¡¨
        function drawSimpleChart(ctx, rect, chartType, statsManager) {
            if (chartType === 'daily') {
                const data = statsManager.getDailyKillData(7);
                drawSimpleLineChart(ctx, rect, data);
            } else if (chartType === 'hourly') {
                const data = statsManager.getHourlyKillData(24);
                drawSimpleBarChart(ctx, rect, data);
            } else {
                const data = statsManager.getDailyKillData(7);
                drawSimpleBarChart(ctx, rect, data);
            }
        }
        
        // ç»˜åˆ¶ç®€å•æŠ˜çº¿å›¾
        function drawSimpleLineChart(ctx, rect, chartData) {
            const padding = 40;
            const chartWidth = rect.width - padding * 2;
            const chartHeight = rect.height - padding * 2;
            const maxValue = Math.max(...chartData.data, 1);
            
            // æ¸…é™¤ç”»å¸ƒ
            ctx.clearRect(0, 0, rect.width, rect.height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, rect.width, rect.height);
            
            // ç»˜åˆ¶åæ ‡è½´
            ctx.strokeStyle = '#bdc3c7';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, rect.height - padding);
            ctx.lineTo(rect.width - padding, rect.height - padding);
            ctx.stroke();
            
            // ç»˜åˆ¶æ•°æ®ç‚¹å’ŒæŠ˜çº¿
            if (chartData.data.length > 1) {
                const stepX = chartWidth / (chartData.data.length - 1);
                
                ctx.strokeStyle = '#3498db';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                chartData.data.forEach((value, index) => {
                    const x = padding + stepX * index;
                    const y = rect.height - padding - (value / maxValue) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                    
                    // ç»˜åˆ¶æ•°æ®ç‚¹
                    ctx.fillStyle = '#3498db';
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, 2 * Math.PI);
                    ctx.fill();
                });
                
                ctx.stroke();
            }
            
            // ç»˜åˆ¶æ ‡é¢˜
            ctx.fillStyle = '#f1c40f';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('æ¯æ—¥å‡»æ€è¶‹åŠ¿', rect.width / 2, 25);
        }
        
        // ç»˜åˆ¶ç®€å•æŸ±çŠ¶å›¾
        function drawSimpleBarChart(ctx, rect, chartData) {
            const padding = 40;
            const chartWidth = rect.width - padding * 2;
            const chartHeight = rect.height - padding * 2;
            const maxValue = Math.max(...chartData.data, 1);
            const barWidth = chartWidth / chartData.data.length * 0.8;
            
            // æ¸…é™¤ç”»å¸ƒ
            ctx.clearRect(0, 0, rect.width, rect.height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, rect.width, rect.height);
            
            // ç»˜åˆ¶åæ ‡è½´
            ctx.strokeStyle = '#bdc3c7';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, rect.height - padding);
            ctx.lineTo(rect.width - padding, rect.height - padding);
            ctx.stroke();
            
            // ç»˜åˆ¶æŸ±çŠ¶å›¾
            chartData.data.forEach((value, index) => {
                const x = padding + (chartWidth / chartData.data.length) * index + (chartWidth / chartData.data.length - barWidth) / 2;
                const barHeight = (value / maxValue) * chartHeight;
                const y = rect.height - padding - barHeight;
                
                ctx.fillStyle = '#e74c3c';
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // ç»˜åˆ¶æ•°å€¼
                if (value > 0) {
                    ctx.fillStyle = '#ecf0f1';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(value.toString(), x + barWidth / 2, y - 5);
                }
            });
            
            // ç»˜åˆ¶æ ‡é¢˜
            ctx.fillStyle = '#f1c40f';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('å‡»æ€ç»Ÿè®¡', rect.width / 2, 25);
        }
        
        // å¤‡ç”¨å›¾è¡¨æµ‹è¯•
        function testChartFallback() {
            console.log('å¼€å§‹å¤‡ç”¨å›¾è¡¨æµ‹è¯•');
            
            const canvas = document.getElementById('stats-chart');
            if (!canvas) {
                console.error('Canvaså…ƒç´ ä¸å­˜åœ¨');
                return false;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('æ— æ³•è·å–Canvasä¸Šä¸‹æ–‡');
                return false;
            }
            
            try {
                const rect = canvas.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                ctx.scale(dpr, dpr);
                
                // ç»˜åˆ¶æµ‹è¯•å›¾æ¡ˆ
                ctx.fillStyle = 'rgba(52, 152, 219, 0.2)';
                ctx.fillRect(0, 0, rect.width, rect.height);
                
                ctx.fillStyle = '#f1c40f';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('å›¾è¡¨åŠŸèƒ½æ­£å¸¸', rect.width / 2, rect.height / 2);
                
                console.log('å¤‡ç”¨å›¾è¡¨æµ‹è¯•å®Œæˆ');
                return true;
            } catch (error) {
                console.error('å¤‡ç”¨å›¾è¡¨æµ‹è¯•å¤±è´¥:', error);
                return false;
            }
        }
        
        // ç«‹å³æ›´æ–°ä¸€æ¬¡ç»Ÿè®¡ï¼ˆç¡®ä¿ä»Šæ—¥å‡»æ€æ•°é‡æ­£ç¡®æ˜¾ç¤ºï¼‰
        setTimeout(() => {
            if (typeof updateStatsFallback === 'function') {
                updateStatsFallback();
                console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ›´æ–°ç»Ÿè®¡');
            }
        }, 1000);
        
        // å¤‡ç”¨çŠ¶æ€æ¢å¤å‡½æ•°
        function restoreStateFallback() {
            console.log('å¼€å§‹æ¢å¤çŠ¶æ€');
            const cells = document.querySelectorAll('td[data-line]');
            
            cells.forEach(cell => {
                const lineNumber = cell.dataset.line;
                const savedState = localStorage.getItem(`pigTimer_line-${lineNumber}`);
                const killTime = localStorage.getItem(`pigTimer_killTime-${lineNumber}`);
                
                if (savedState) {
                    if (savedState === 'killed' && killTime) {
                        cell.classList.add('killed');
                        const killTimeNum = parseInt(killTime);
                        const currentTime = new Date().getTime();
                        const testMode = localStorage.getItem('pigTimer_testMode') === 'true';
                        const timerDuration = testMode ? 10000 : (24 * 60 * 60 * 1000);
                        const elapsed = currentTime - killTimeNum;
                        
                        if (elapsed < timerDuration) {
                            // ç»§ç»­å€’è®¡æ—¶
                            startTimerFallback(lineNumber, killTimeNum, cell);
                        } else {
                            // æ—¶é—´å·²åˆ°ï¼Œè®¾ä¸ºåˆ·æ–°çŠ¶æ€
                            cell.classList.remove('killed');
                            cell.classList.add('refreshed');
                            localStorage.setItem(`pigTimer_line-${lineNumber}`, 'refreshed');
                        }
                    } else if (savedState === 'killed-unknown') {
                        cell.classList.add('killed-unknown');
                    } else if (savedState === 'refreshed') {
                        cell.classList.add('refreshed');
                    }
                }
            });
            
            // æ›´æ–°ç»Ÿè®¡
            updateStatsFallback();
            console.log('çŠ¶æ€æ¢å¤å®Œæˆ');
            
            // ç¡®ä¿é¡µé¢åŠ è½½æ—¶ä¹Ÿæ›´æ–°ä»Šæ—¥å‡»æ€æ•°é‡
            setTimeout(updateStatsFallback, 1000);
        }
    </script>
    
    <!-- è°ƒè¯•è„šæœ¬ -->
    <script>
        // å»¶è¿Ÿæ£€æŸ¥è¡¨æ ¼çŠ¶æ€
        setTimeout(() => {
            const table = document.getElementById('line-table');
            const cells = table ? table.querySelectorAll('td[data-line]') : [];
            
            document.getElementById('debug-table-status').textContent = 
                table ? (cells.length > 0 ? 'âœ… æ­£å¸¸' : 'âš ï¸ ç©ºè¡¨æ ¼') : 'âŒ æœªæ‰¾åˆ°';
            document.getElementById('debug-cell-count').textContent = cells.length;
            
            if (cells.length === 0) {
                console.error('è¡¨æ ¼ç”Ÿæˆå¤±è´¥ï¼Œæ£€æŸ¥æ§åˆ¶å°é”™è¯¯');
            }
        }, 2000);
    </script>
</body>
</html>