<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebaseè¯¦ç»†è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .error-section {
            background: #fff5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #dc3545;
        }
        .success-section {
            background: #f0f8f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #28a745;
        }
        .console {
            background: #1e1e1e;
            color: #ffffff;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .step {
            background: #e3f2fd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Firebaseè¯¦ç»†è°ƒè¯•å·¥å…·</h1>
        
        <div class="debug-section">
            <h3>ğŸ¯ å½“å‰é…ç½®ä¿¡æ¯</h3>
            <pre id="config-info">æ­£åœ¨æ£€æŸ¥é…ç½®...</pre>
        </div>
        
        <div>
            <button onclick="step1_checkEnvironment()">æ­¥éª¤1: æ£€æŸ¥ç¯å¢ƒ</button>
            <button onclick="step2_testFirebaseSDK()">æ­¥éª¤2: æµ‹è¯•Firebase SDK</button>
            <button onclick="step3_testAuth()">æ­¥éª¤3: æµ‹è¯•è®¤è¯</button>
            <button onclick="step4_testDatabase()">æ­¥éª¤4: æµ‹è¯•æ•°æ®åº“</button>
            <button onclick="runAllSteps()">ğŸš€ è¿è¡Œæ‰€æœ‰æ­¥éª¤</button>
            <button onclick="clearConsole()">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
        
        <div id="console" class="console">
            å‡†å¤‡å¼€å§‹Firebaseè¯¦ç»†è°ƒè¯•...
        </div>

        <div class="debug-section">
            <h3>ğŸ“‹ æ‰‹åŠ¨æ£€æŸ¥æ¸…å•</h3>
            <div class="step">
                <strong>1. æ£€æŸ¥Authenticationè®¾ç½®</strong><br>
                è®¿é—®: <a href="https://console.firebase.google.com/project/pig-timer-collaboration/authentication/providers" target="_blank">Authentication â†’ ç™»å½•æ–¹æ³•</a><br>
                ç¡®ä¿"åŒ¿å"æä¾›å•†å·²å¯ç”¨
            </div>
            <div class="step">
                <strong>2. æ£€æŸ¥Realtime Databaseè§„åˆ™</strong><br>
                è®¿é—®: <a href="https://console.firebase.google.com/project/pig-timer-collaboration/database/pig-timer-collaboration-default-rtdb/rules" target="_blank">Realtime Database â†’ è§„åˆ™</a><br>
                è®¾ç½®ä¸º: <code>{ "rules": { ".read": true, ".write": true } }</code>
            </div>
            <div class="step">
                <strong>3. æ£€æŸ¥ç½‘ç»œè¿æ¥</strong><br>
                ç¡®ä¿å¯ä»¥è®¿é—®: <code>https://firebase.googleapis.com</code>
            </div>
        </div>
    </div>

    <script type="module">
        // ä½¿ç”¨ä½ æˆªå›¾ä¸­æ˜¾ç¤ºçš„å®Œæ•´é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBgbodFry-hFl_tiWK9CAYzZ_4FFizc3kE",
            authDomain: "pig-timer-collaboration.firebaseapp.com",
            databaseURL: "https://pig-timer-collaboration-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pig-timer-collaboration",
            storageBucket: "pig-timer-collaboration.firebasestorage.app",
            messagingSenderId: "629352460916",
            appId: "1:629352460916:web:248d4051b64d8cb4e51721",
            measurementId: "G-5RMRLLTTRP"
        };

        let globalApp, globalAuth, globalDatabase;

        // æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        document.getElementById('config-info').textContent = JSON.stringify(firebaseConfig, null, 2);

        // æ§åˆ¶å°è¾“å‡ºå‡½æ•°
        function logToConsole(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#ffffff',
                success: '#4caf50',
                error: '#f44336',
                warning: '#ff9800',
                debug: '#9c27b0'
            };
            
            console.innerHTML += `<div style="color: ${colors[type]}; margin: 3px 0;">[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        // æ­¥éª¤1: æ£€æŸ¥ç¯å¢ƒ
        async function step1_checkEnvironment() {
            logToConsole('=== æ­¥éª¤1: æ£€æŸ¥ç¯å¢ƒ ===', 'debug');
            
            // æ£€æŸ¥æµè§ˆå™¨
            logToConsole(`æµè§ˆå™¨: ${navigator.userAgent}`, 'info');
            logToConsole(`å½“å‰URL: ${window.location.href}`, 'info');
            
            // æ£€æŸ¥ç½‘ç»œè¿æ¥
            try {
                const response = await fetch('https://www.googleapis.com/firebase/v1beta1/projects/pig-timer-collaboration');
                logToConsole('âœ… Firebase APIå¯è®¿é—®', 'success');
            } catch (error) {
                logToConsole(`âŒ Firebase APIè®¿é—®å¤±è´¥: ${error.message}`, 'error');
                logToConsole('ğŸ’¡ å¯èƒ½éœ€è¦ç§‘å­¦ä¸Šç½‘å·¥å…·', 'warning');
            }
            
            // æ£€æŸ¥CDNè¿æ¥
            try {
                const response = await fetch('https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js', { method: 'HEAD' });
                logToConsole('âœ… Firebase CDNå¯è®¿é—®', 'success');
            } catch (error) {
                logToConsole(`âŒ Firebase CDNè®¿é—®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ­¥éª¤2: æµ‹è¯•Firebase SDK
        async function step2_testFirebaseSDK() {
            logToConsole('=== æ­¥éª¤2: æµ‹è¯•Firebase SDK ===', 'debug');
            
            try {
                // åŠ¨æ€å¯¼å…¥Firebaseæ¨¡å—
                logToConsole('æ­£åœ¨å¯¼å…¥Firebaseæ¨¡å—...', 'info');
                
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js');
                const { getAuth, signInAnonymously, connectAuthEmulator } = await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js');
                const { getDatabase, ref, set, get, connectDatabaseEmulator } = await import('https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js');
                
                logToConsole('âœ… Firebaseæ¨¡å—å¯¼å…¥æˆåŠŸ', 'success');
                
                // åˆå§‹åŒ–Firebaseåº”ç”¨
                logToConsole('æ­£åœ¨åˆå§‹åŒ–Firebaseåº”ç”¨...', 'info');
                globalApp = initializeApp(firebaseConfig);
                logToConsole('âœ… Firebaseåº”ç”¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                // è·å–æœåŠ¡å®ä¾‹
                globalAuth = getAuth(globalApp);
                globalDatabase = getDatabase(globalApp);
                logToConsole('âœ… FirebaseæœåŠ¡å®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');
                
                window.firebaseServices = { globalApp, globalAuth, globalDatabase, signInAnonymously, ref, set, get };
                
            } catch (error) {
                logToConsole(`âŒ Firebase SDKåŠ è½½å¤±è´¥: ${error.message}`, 'error');
                logToConsole(`é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
            }
        }

        // æ­¥éª¤3: æµ‹è¯•è®¤è¯
        async function step3_testAuth() {
            logToConsole('=== æ­¥éª¤3: æµ‹è¯•è®¤è¯ ===', 'debug');
            
            if (!globalAuth) {
                logToConsole('âŒ è¯·å…ˆè¿è¡Œæ­¥éª¤2', 'error');
                return;
            }
            
            try {
                logToConsole('æ­£åœ¨å°è¯•åŒ¿åç™»å½•...', 'info');
                
                const { signInAnonymously } = window.firebaseServices;
                const userCredential = await signInAnonymously(globalAuth);
                const user = userCredential.user;
                
                logToConsole(`âœ… åŒ¿åç™»å½•æˆåŠŸ!`, 'success');
                logToConsole(`ç”¨æˆ·ID: ${user.uid}`, 'info');
                logToConsole(`æ˜¯å¦åŒ¿å: ${user.isAnonymous}`, 'info');
                
                window.currentUser = user;
                
            } catch (error) {
                logToConsole(`âŒ åŒ¿åç™»å½•å¤±è´¥: ${error.code} - ${error.message}`, 'error');
                
                if (error.code === 'auth/operation-not-allowed') {
                    logToConsole('ğŸ”§ è§£å†³æ–¹æ¡ˆ: éœ€è¦åœ¨Firebaseæ§åˆ¶å°å¯ç”¨åŒ¿åè®¤è¯', 'warning');
                    logToConsole('ğŸ“– è·¯å¾„: Authentication â†’ ç™»å½•æ–¹æ³• â†’ åŒ¿å â†’ å¯ç”¨', 'warning');
                } else if (error.code === 'auth/network-request-failed') {
                    logToConsole('ğŸ”§ è§£å†³æ–¹æ¡ˆ: æ£€æŸ¥ç½‘ç»œè¿æ¥', 'warning');
                } else {
                    logToConsole(`ğŸ”§ é”™è¯¯ä»£ç è§£é‡Š: ${error.code}`, 'warning');
                }
            }
        }

        // æ­¥éª¤4: æµ‹è¯•æ•°æ®åº“
        async function step4_testDatabase() {
            logToConsole('=== æ­¥éª¤4: æµ‹è¯•æ•°æ®åº“ ===', 'debug');
            
            if (!globalDatabase || !window.currentUser) {
                logToConsole('âŒ è¯·å…ˆå®Œæˆæ­¥éª¤2å’Œæ­¥éª¤3', 'error');
                return;
            }
            
            try {
                const { ref, set, get } = window.firebaseServices;
                const userId = window.currentUser.uid;
                
                // æµ‹è¯•å†™å…¥
                logToConsole('æ­£åœ¨æµ‹è¯•æ•°æ®åº“å†™å…¥...', 'info');
                const testRef = ref(globalDatabase, `debug_test/${userId}`);
                const testData = {
                    timestamp: Date.now(),
                    message: 'Firebaseè°ƒè¯•æµ‹è¯•',
                    randomValue: Math.random()
                };
                
                await set(testRef, testData);
                logToConsole('âœ… æ•°æ®åº“å†™å…¥æˆåŠŸ', 'success');
                
                // æµ‹è¯•è¯»å–
                logToConsole('æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¯»å–...', 'info');
                const snapshot = await get(testRef);
                
                if (snapshot.exists()) {
                    logToConsole('âœ… æ•°æ®åº“è¯»å–æˆåŠŸ', 'success');
                    logToConsole(`è¯»å–çš„æ•°æ®: ${JSON.stringify(snapshot.val())}`, 'info');
                    logToConsole('ğŸ‰ Firebaseå®Œå…¨æ­£å¸¸å·¥ä½œï¼', 'success');
                } else {
                    logToConsole('âš ï¸ æ•°æ®åº“è¯»å–å¤±è´¥: æ•°æ®ä¸å­˜åœ¨', 'warning');
                }
                
            } catch (error) {
                logToConsole(`âŒ æ•°æ®åº“æ“ä½œå¤±è´¥: ${error.code} - ${error.message}`, 'error');
                
                if (error.code === 'PERMISSION_DENIED' || error.message.includes('permission-denied')) {
                    logToConsole('ğŸ”§ è§£å†³æ–¹æ¡ˆ: æ•°æ®åº“å®‰å…¨è§„åˆ™é—®é¢˜', 'warning');
                    logToConsole('ğŸ“– è®¾ç½®è§„åˆ™ä¸º: { "rules": { ".read": true, ".write": true } }', 'warning');
                } else if (error.message.includes('Invalid token in path')) {
                    logToConsole('ğŸ”§ è§£å†³æ–¹æ¡ˆ: è®¤è¯tokenæ— æ•ˆï¼Œå¯èƒ½æ˜¯è§„åˆ™é…ç½®é—®é¢˜', 'warning');
                }
            }
        }

        // è¿è¡Œæ‰€æœ‰æ­¥éª¤
        async function runAllSteps() {
            logToConsole('ğŸš€ å¼€å§‹å®Œæ•´çš„Firebaseè°ƒè¯•æµç¨‹...', 'debug');
            
            await step1_checkEnvironment();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await step2_testFirebaseSDK();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await step3_testAuth();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await step4_testDatabase();
            
            logToConsole('ğŸ è°ƒè¯•æµç¨‹å®Œæˆ', 'debug');
        }

        // æ¸…ç©ºæ§åˆ¶å°
        function clearConsole() {
            document.getElementById('console').innerHTML = 'æ§åˆ¶å°å·²æ¸…ç©º...';
        }

        // æš´éœ²å‡½æ•°åˆ°å…¨å±€
        window.step1_checkEnvironment = step1_checkEnvironment;
        window.step2_testFirebaseSDK = step2_testFirebaseSDK;
        window.step3_testAuth = step3_testAuth;
        window.step4_testDatabase = step4_testDatabase;
        window.runAllSteps = runAllSteps;
        window.clearConsole = clearConsole;

        // é¡µé¢åŠ è½½å®Œæˆåçš„æç¤º
        window.addEventListener('load', () => {
            logToConsole('ğŸ”§ Firebaseè¯¦ç»†è°ƒè¯•å·¥å…·å·²å‡†å¤‡å°±ç»ª', 'success');
            logToConsole('ğŸ’¡ å»ºè®®ç‚¹å‡»"è¿è¡Œæ‰€æœ‰æ­¥éª¤"è¿›è¡Œå®Œæ•´æµ‹è¯•', 'info');
        });
    </script>
</body>
</html>
