<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¿é—´çŠ¶æ€è°ƒè¯•</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body {
            background: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
        }
        .debug-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .debug-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            margin: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .debug-btn:hover {
            background: #0056b3;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- æˆ¿é—´çŠ¶æ€ç»„ä»¶ -->
    <div id="room-status-widget" class="room-status-widget" style="display: none;">
        <div class="room-status-header">
            <span class="room-status-icon">ğŸ </span>
            <span class="room-status-title">åä½œæˆ¿é—´</span>
            <button class="room-status-close" onclick="hideRoomStatus()">Ã—</button>
        </div>
        <div class="room-status-content">
            <div class="room-info">
                <div class="room-id-section">
                    <label>æˆ¿é—´å·: <small style="color: rgba(255,255,255,0.6);">(ç‚¹å‡»ğŸ“‹å¤åˆ¶)</small></label>
                    <div class="room-id-display">
                        <input type="text" id="room-id-input" readonly class="room-id-input" placeholder="æš‚æ— æˆ¿é—´å·">
                        <button class="copy-btn" onclick="copyRoomId()" title="å¤åˆ¶æˆ¿é—´å·">ğŸ“‹</button>
                    </div>
                </div>
                <div class="room-details">
                    <div class="room-detail-item">
                        <span class="label">çŠ¶æ€:</span>
                        <span id="room-connection-status" class="status">ç¦»çº¿</span>
                    </div>
                    <div class="room-detail-item">
                        <span class="label">ç”¨æˆ·:</span>
                        <span id="room-user-count" class="count">0</span>
                    </div>
                    <div class="room-detail-item">
                        <span class="label">ç±»å‹:</span>
                        <span id="room-type" class="type">-</span>
                    </div>
                </div>
            </div>
            <div class="room-actions">
                <button class="action-btn small secondary" onclick="leaveRoom()">ç¦»å¼€æˆ¿é—´</button>
                <button class="action-btn small primary" onclick="showRoomDetails()">æˆ¿é—´è¯¦æƒ…</button>
            </div>
        </div>
    </div>

    <div class="debug-container">
        <h1>ğŸ”§ æˆ¿é—´çŠ¶æ€ç»„ä»¶è°ƒè¯•</h1>
        
        <div class="debug-section">
            <h2>æµ‹è¯•æ“ä½œ</h2>
            <button class="debug-btn" onclick="testShowRoom()">æ˜¾ç¤ºæµ‹è¯•æˆ¿é—´</button>
            <button class="debug-btn" onclick="testShowLongRoomId()">æ˜¾ç¤ºé•¿æˆ¿é—´å·</button>
            <button class="debug-btn" onclick="testShowEmptyRoom()">æ˜¾ç¤ºç©ºæˆ¿é—´å·</button>
            <button class="debug-btn" onclick="hideRoomStatus()">éšè—æˆ¿é—´</button>
            <button class="debug-btn" onclick="testCopyFunction()">æµ‹è¯•å¤åˆ¶åŠŸèƒ½</button>
            <button class="debug-btn" onclick="debugElements()">æ£€æŸ¥DOMå…ƒç´ </button>
            <button class="debug-btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="log-area" id="log-area">
            è°ƒè¯•æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...<br>
        </div>

        <div class="debug-section">
            <h2>å½“å‰çŠ¶æ€</h2>
            <p>æˆ¿é—´çŠ¶æ€ç»„ä»¶æ˜¾ç¤º: <span id="widget-visible">å¦</span></p>
            <p>æˆ¿é—´å·è¾“å…¥æ¡†å€¼: <span id="room-id-value">ç©º</span></p>
            <p>æˆ¿é—´å·è¾“å…¥æ¡†æ ·å¼: <span id="room-id-style">æ£€æŸ¥ä¸­...</span></p>
        </div>
    </div>

    <script>
        // æ—¥å¿—åŠŸèƒ½
        function log(message) {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}<br>`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log-area').innerHTML = 'æ—¥å¿—å·²æ¸…ç©º<br>';
        }

        // å½“å‰æˆ¿é—´ä¿¡æ¯
        let currentRoomInfo = {
            roomId: null,
            type: null,
            userCount: 0,
            isConnected: false
        };

        // æ˜¾ç¤ºæˆ¿é—´çŠ¶æ€ç»„ä»¶
        function showRoomStatus(roomId, type = 'Firebase') {
            log(`showRoomStatus è¢«è°ƒç”¨ï¼Œå‚æ•°: roomId="${roomId}", type="${type}"`);
            
            currentRoomInfo.roomId = roomId;
            currentRoomInfo.type = type;
            currentRoomInfo.isConnected = true;
            
            const widget = document.getElementById('room-status-widget');
            const roomIdInput = document.getElementById('room-id-input');
            const roomType = document.getElementById('room-type');
            const connectionStatus = document.getElementById('room-connection-status');
            
            log(`DOM å…ƒç´ æŸ¥æ‰¾ç»“æœ: widget=${!!widget}, roomIdInput=${!!roomIdInput}, roomType=${!!roomType}, connectionStatus=${!!connectionStatus}`);
            
            if (roomIdInput) {
                log(`è®¾ç½®æˆ¿é—´å·è¾“å…¥æ¡†å€¼: "${roomId}"`);
                roomIdInput.value = roomId;
                log(`è¾“å…¥æ¡†å€¼è®¾ç½®å: "${roomIdInput.value}"`);
                
                // æ£€æŸ¥æ ·å¼
                const computedStyle = window.getComputedStyle(roomIdInput);
                log(`è¾“å…¥æ¡†è®¡ç®—æ ·å¼ - color: ${computedStyle.color}, background: ${computedStyle.backgroundColor}`);
            } else {
                log('âŒ æˆ¿é—´å·è¾“å…¥æ¡†æœªæ‰¾åˆ°');
            }
            
            if (roomType) {
                roomType.textContent = type;
                log(`æˆ¿é—´ç±»å‹è®¾ç½®ä¸º: ${type}`);
            }
            
            if (connectionStatus) {
                connectionStatus.textContent = 'åœ¨çº¿';
                connectionStatus.className = 'status online';
                log('è¿æ¥çŠ¶æ€è®¾ç½®ä¸º: åœ¨çº¿');
            }
            
            if (widget) {
                widget.style.display = 'block';
                log('æˆ¿é—´çŠ¶æ€ç»„ä»¶æ˜¾ç¤º');
            } else {
                log('âŒ æˆ¿é—´çŠ¶æ€ç»„ä»¶æœªæ‰¾åˆ°');
            }
            
            updateStatus();
            log('âœ… æˆ¿é—´çŠ¶æ€ç»„ä»¶è®¾ç½®å®Œæˆ');
        }

        // éšè—æˆ¿é—´çŠ¶æ€ç»„ä»¶
        function hideRoomStatus() {
            log('hideRoomStatus è¢«è°ƒç”¨');
            const widget = document.getElementById('room-status-widget');
            if (widget) {
                widget.style.display = 'none';
                log('æˆ¿é—´çŠ¶æ€ç»„ä»¶å·²éšè—');
            }
            
            currentRoomInfo = {
                roomId: null,
                type: null,
                userCount: 0,
                isConnected: false
            };
            
            updateStatus();
        }

        // æ›´æ–°æˆ¿é—´ç”¨æˆ·æ•°
        function updateRoomUserCount(count) {
            log(`updateRoomUserCount è¢«è°ƒç”¨: ${count}`);
            const userCountElement = document.getElementById('room-user-count');
            if (userCountElement) {
                userCountElement.textContent = count;
                currentRoomInfo.userCount = count;
                log(`ç”¨æˆ·æ•°å·²æ›´æ–°: ${count}`);
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(isConnected) {
            log(`updateConnectionStatus è¢«è°ƒç”¨: ${isConnected}`);
            const statusElement = document.getElementById('room-connection-status');
            if (statusElement) {
                currentRoomInfo.isConnected = isConnected;
                if (isConnected) {
                    statusElement.textContent = 'åœ¨çº¿';
                    statusElement.className = 'status online';
                } else {
                    statusElement.textContent = 'ç¦»çº¿';
                    statusElement.className = 'status offline';
                }
                log(`è¿æ¥çŠ¶æ€å·²æ›´æ–°: ${isConnected ? 'åœ¨çº¿' : 'ç¦»çº¿'}`);
            }
        }

        // å¤åˆ¶æˆ¿é—´å·
        async function copyRoomId() {
            log('copyRoomId è¢«è°ƒç”¨');
            const roomIdInput = document.getElementById('room-id-input');
            const copyBtn = document.querySelector('.copy-btn');
            
            if (roomIdInput && roomIdInput.value) {
                const roomId = roomIdInput.value;
                log(`å°è¯•å¤åˆ¶æˆ¿é—´å·: "${roomId}"`);
                
                try {
                    // ä¼˜å…ˆä½¿ç”¨ç°ä»£Clipboard API
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(roomId);
                        log('ä½¿ç”¨ Clipboard API å¤åˆ¶æˆåŠŸ');
                    } else {
                        // é™çº§ä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                        roomIdInput.select();
                        roomIdInput.setSelectionRange(0, 99999);
                        document.execCommand('copy');
                        log('ä½¿ç”¨ execCommand å¤åˆ¶æˆåŠŸ');
                    }
                    
                    // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸåŠ¨ç”»
                    if (copyBtn) {
                        copyBtn.classList.add('copied');
                        copyBtn.textContent = 'âœ…';
                        
                        setTimeout(() => {
                            copyBtn.classList.remove('copied');
                            copyBtn.textContent = 'ğŸ“‹';
                        }, 1000);
                    }
                    
                    log('âœ… å¤åˆ¶æˆåŠŸ');
                    
                } catch (err) {
                    log(`âŒ å¤åˆ¶å¤±è´¥: ${err.message}`);
                    
                    // å¤‡ç”¨æ–¹æ³•ï¼šé€‰æ‹©æ–‡æœ¬è®©ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
                    roomIdInput.select();
                    roomIdInput.setSelectionRange(0, 99999);
                }
            } else {
                log('âŒ æ²¡æœ‰æˆ¿é—´å·å¯å¤åˆ¶');
            }
        }

        // å…¶ä»–åŠŸèƒ½å‡½æ•°
        function leaveRoom() {
            log('leaveRoom è¢«è°ƒç”¨');
            if (confirm('ç¡®å®šè¦ç¦»å¼€å½“å‰æˆ¿é—´å—ï¼Ÿ')) {
                hideRoomStatus();
            }
        }

        function showRoomDetails() {
            log('showRoomDetails è¢«è°ƒç”¨');
            const details = `æˆ¿é—´è¯¦æƒ…ï¼š
æˆ¿é—´å·: ${currentRoomInfo.roomId}
ç±»å‹: ${currentRoomInfo.type}
ç”¨æˆ·æ•°: ${currentRoomInfo.userCount}
çŠ¶æ€: ${currentRoomInfo.isConnected ? 'åœ¨çº¿' : 'ç¦»çº¿'}`;
            
            alert(details);
        }

        // æµ‹è¯•å‡½æ•°
        function testShowRoom() {
            const testRoomId = 'test_room_' + Math.random().toString(36).substring(7);
            log(`æµ‹è¯•æ˜¾ç¤ºæˆ¿é—´: ${testRoomId}`);
            showRoomStatus(testRoomId, 'Firebaseæµ‹è¯•');
            updateRoomUserCount(1);
        }

        function testShowLongRoomId() {
            const longRoomId = 'very_long_room_id_with_many_characters_' + Math.random().toString(36).substring(7);
            log(`æµ‹è¯•æ˜¾ç¤ºé•¿æˆ¿é—´å·: ${longRoomId}`);
            showRoomStatus(longRoomId, 'Firebase');
            updateRoomUserCount(3);
        }

        function testShowEmptyRoom() {
            log('æµ‹è¯•æ˜¾ç¤ºç©ºæˆ¿é—´å·');
            showRoomStatus('', 'Firebase');
        }

        function testCopyFunction() {
            log('æµ‹è¯•å¤åˆ¶åŠŸèƒ½');
            if (currentRoomInfo.roomId) {
                copyRoomId();
            } else {
                log('âŒ å½“å‰æ²¡æœ‰æˆ¿é—´å·ï¼Œå…ˆæ˜¾ç¤ºä¸€ä¸ªæµ‹è¯•æˆ¿é—´');
                testShowRoom();
                setTimeout(() => {
                    copyRoomId();
                }, 100);
            }
        }

        function debugElements() {
            log('=== DOM å…ƒç´ è°ƒè¯•ä¿¡æ¯ ===');
            
            const widget = document.getElementById('room-status-widget');
            const roomIdInput = document.getElementById('room-id-input');
            
            log(`æˆ¿é—´çŠ¶æ€ç»„ä»¶å­˜åœ¨: ${!!widget}`);
            if (widget) {
                log(`ç»„ä»¶æ˜¾ç¤ºçŠ¶æ€: ${widget.style.display}`);
                log(`ç»„ä»¶ç±»å: ${widget.className}`);
            }
            
            log(`æˆ¿é—´å·è¾“å…¥æ¡†å­˜åœ¨: ${!!roomIdInput}`);
            if (roomIdInput) {
                log(`è¾“å…¥æ¡†å€¼: "${roomIdInput.value}"`);
                log(`è¾“å…¥æ¡†å ä½ç¬¦: "${roomIdInput.placeholder}"`);
                log(`è¾“å…¥æ¡†ç±»å: ${roomIdInput.className}`);
                
                const computedStyle = window.getComputedStyle(roomIdInput);
                log(`è®¡ç®—æ ·å¼ - color: ${computedStyle.color}`);
                log(`è®¡ç®—æ ·å¼ - backgroundColor: ${computedStyle.backgroundColor}`);
                log(`è®¡ç®—æ ·å¼ - fontSize: ${computedStyle.fontSize}`);
                log(`è®¡ç®—æ ·å¼ - fontFamily: ${computedStyle.fontFamily}`);
            }
            
            log('=== è°ƒè¯•ä¿¡æ¯ç»“æŸ ===');
        }

        function updateStatus() {
            const widget = document.getElementById('room-status-widget');
            const roomIdInput = document.getElementById('room-id-input');
            
            document.getElementById('widget-visible').textContent = 
                widget && widget.style.display !== 'none' ? 'æ˜¯' : 'å¦';
            
            document.getElementById('room-id-value').textContent = 
                roomIdInput ? `"${roomIdInput.value}"` : 'å…ƒç´ ä¸å­˜åœ¨';
            
            if (roomIdInput) {
                const computedStyle = window.getComputedStyle(roomIdInput);
                document.getElementById('room-id-style').textContent = 
                    `color: ${computedStyle.color}, background: ${computedStyle.backgroundColor}`;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è°ƒè¯•');
            updateStatus();
            debugElements();
        });

        // å®šæœŸæ›´æ–°çŠ¶æ€æ˜¾ç¤º
        setInterval(updateStatus, 1000);
    </script>
</body>
</html>
