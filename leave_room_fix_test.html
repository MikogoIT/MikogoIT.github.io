<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦»å¼€æˆ¿é—´åŠŸèƒ½ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-btn:hover {
            background: #2980b9;
        }
        .test-btn.danger {
            background: #e74c3c;
        }
        .test-btn.danger:hover {
            background: #c0392b;
        }
        .status {
            background: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
        .log-area {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 13px;
            margin: 20px 0;
        }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .warning { color: #f39c12; }
        .info { color: #3498db; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ ç¦»å¼€æˆ¿é—´åŠŸèƒ½ä¿®å¤æµ‹è¯•</h1>
        
        <div class="status" id="status">
            ç­‰å¾…æµ‹è¯•...
        </div>
        
        <div>
            <h3>ğŸ§ª æµ‹è¯•æ­¥éª¤ï¼š</h3>
            <ol>
                <li>é¦–å…ˆåœ¨ä¸»é¡µé¢ä¸­åˆ›å»ºæˆ–åŠ å…¥ä¸€ä¸ªæˆ¿é—´</li>
                <li>ç¡®ä¿èƒ½çœ‹åˆ°æˆ¿é—´ä¿¡æ¯é¢æ¿</li>
                <li>ä½¿ç”¨ä¸‹é¢çš„æŒ‰é’®è¿›è¡Œæµ‹è¯•</li>
            </ol>
        </div>
        
        <div>
            <h3>ğŸ” è¯Šæ–­å·¥å…·ï¼š</h3>
            <button class="test-btn" onclick="runDiagnostics()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
            <button class="test-btn" onclick="checkRoomStatus()">æ£€æŸ¥æˆ¿é—´çŠ¶æ€</button>
            <button class="test-btn" onclick="checkLeaveButton()">æ£€æŸ¥ç¦»å¼€æŒ‰é’®</button>
            <button class="test-btn" onclick="testFirebaseConnection()">æµ‹è¯•Firebaseè¿æ¥</button>
        </div>
        
        <div>
            <h3>ğŸ¯ ç¦»å¼€æˆ¿é—´æµ‹è¯•ï¼š</h3>
            <button class="test-btn danger" onclick="testLeaveRoom()">æµ‹è¯•ç¦»å¼€æˆ¿é—´</button>
            <button class="test-btn danger" onclick="forceLeaveRoom()">å¼ºåˆ¶ç¦»å¼€æˆ¿é—´</button>
            <button class="test-btn danger" onclick="simulateButtonClick()">æ¨¡æ‹ŸæŒ‰é’®ç‚¹å‡»</button>
        </div>
        
        <div>
            <h3>ğŸ“‹ æ§åˆ¶å°æ—¥å¿—ï¼š</h3>
            <div class="log-area" id="log-area"></div>
            <button class="test-btn" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            <button class="test-btn" onclick="exportLogs()">å¯¼å‡ºæ—¥å¿—</button>
        </div>
        
        <div>
            <h3>â„¹ï¸ ä¿®å¤å†…å®¹ï¼š</h3>
            <ul>
                <li>âœ… æ”¹è¿›äº†äº‹ä»¶ç›‘å¬å™¨ç»‘å®šæœºåˆ¶</li>
                <li>âœ… æ·»åŠ äº†æ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•</li>
                <li>âœ… å¢åŠ äº†ç½‘ç»œè¿æ¥æ£€æŸ¥å’Œé‡è¯•æœºåˆ¶</li>
                <li>âœ… å®ç°äº†å¼ºåˆ¶æ¸…ç†åŠŸèƒ½é˜²æ­¢å¡æ­»</li>
                <li>âœ… æ·»åŠ äº†æŒ‰é’®çŠ¶æ€ç®¡ç†é˜²æ­¢é‡å¤ç‚¹å‡»</li>
                <li>âœ… æ”¹å–„äº†CSSæ ·å¼ç¡®ä¿æŒ‰é’®å¯ç‚¹å‡»æ€§</li>
            </ul>
        </div>
    </div>

    <script>
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            logs.push(logEntry);
            console.log(message);
            
            const logArea = document.getElementById('log-area');
            const logDiv = document.createElement('div');
            logDiv.className = type;
            logDiv.textContent = logEntry;
            logArea.appendChild(logDiv);
            logArea.scrollTop = logArea.scrollHeight;
            
            // æ›´æ–°çŠ¶æ€
            document.getElementById('status').textContent = `[${timestamp}] ${message}`;
        }
        
        function clearLogs() {
            logs = [];
            document.getElementById('log-area').innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©º');
        }
        
        function exportLogs() {
            const logText = logs.join('\\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `leave-room-test-logs-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('æ—¥å¿—å·²å¯¼å‡º');
        }
        
        function runDiagnostics() {
            log('ğŸ” å¼€å§‹è¿è¡Œå®Œæ•´è¯Šæ–­...', 'info');
            
            // æ£€æŸ¥Firebase Manager
            if (window.parent.app && window.parent.app.firebaseManager) {
                const fm = window.parent.app.firebaseManager;
                log('âœ… æ‰¾åˆ°FirebaseManagerå®ä¾‹', 'success');
                log(`æˆ¿é—´çŠ¶æ€: ${fm.roomId ? fm.roomId : 'æœªåŠ å…¥æˆ¿é—´'}`, 'info');
                log(`ç”¨æˆ·è§’è‰²: ${fm.isHost ? 'æˆ¿ä¸»' : 'æˆå‘˜'}`, 'info');
                log(`è¿æ¥çŠ¶æ€: ${fm.isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}`, fm.isConnected ? 'success' : 'warning');
            } else {
                log('âŒ æœªæ‰¾åˆ°FirebaseManagerå®ä¾‹', 'error');
            }
            
            // æ£€æŸ¥ç¦»å¼€æŒ‰é’®
            const leaveBtn = window.parent.document.getElementById('leave-room-btn');
            if (leaveBtn) {
                log('âœ… æ‰¾åˆ°ç¦»å¼€æˆ¿é—´æŒ‰é’®', 'success');
                const rect = leaveBtn.getBoundingClientRect();
                log(`æŒ‰é’®ä½ç½®: (${rect.left}, ${rect.top})`, 'info');
                log(`æŒ‰é’®å¤§å°: ${rect.width} x ${rect.height}`, 'info');
                log(`æŒ‰é’®å¯è§: ${rect.width > 0 && rect.height > 0}`, rect.width > 0 ? 'success' : 'error');
            } else {
                log('âŒ æœªæ‰¾åˆ°ç¦»å¼€æˆ¿é—´æŒ‰é’®', 'error');
            }
            
            // æ£€æŸ¥å…¨å±€å‡½æ•°
            const globalFunctions = [
                'globalLeaveRoom',
                'debugLeaveRoom'
            ];
            
            globalFunctions.forEach(funcName => {
                if (typeof window.parent[funcName] === 'function') {
                    log(`âœ… æ‰¾åˆ°å…¨å±€å‡½æ•°: ${funcName}`, 'success');
                } else {
                    log(`âŒ æœªæ‰¾åˆ°å…¨å±€å‡½æ•°: ${funcName}`, 'warning');
                }
            });
            
            log('ğŸ è¯Šæ–­å®Œæˆ', 'info');
        }
        
        function checkRoomStatus() {
            log('ğŸ  æ£€æŸ¥æˆ¿é—´çŠ¶æ€...', 'info');
            
            if (window.parent.app && window.parent.app.firebaseManager) {
                const fm = window.parent.app.firebaseManager;
                
                const status = {
                    roomId: fm.roomId,
                    isHost: fm.isHost,
                    userId: fm.userId,
                    userName: fm.userName,
                    isInitialized: fm.isInitialized,
                    isConnected: fm.isConnected
                };
                
                Object.entries(status).forEach(([key, value]) => {
                    log(`${key}: ${value}`, 'info');
                });
            } else {
                log('âŒ æ— æ³•è®¿é—®FirebaseManager', 'error');
            }
        }
        
        function checkLeaveButton() {
            log('ğŸ”˜ æ£€æŸ¥ç¦»å¼€æˆ¿é—´æŒ‰é’®...', 'info');
            
            const leaveBtn = window.parent.document.getElementById('leave-room-btn');
            if (leaveBtn) {
                const style = window.parent.getComputedStyle(leaveBtn);
                const rect = leaveBtn.getBoundingClientRect();
                
                log(`æ˜¾ç¤ºçŠ¶æ€: ${style.display}`, 'info');
                log(`å¯è§æ€§: ${style.visibility}`, 'info');
                log(`é€æ˜åº¦: ${style.opacity}`, 'info');
                log(`æŒ‡é’ˆäº‹ä»¶: ${style.pointerEvents}`, 'info');
                log(`æ˜¯å¦ç¦ç”¨: ${leaveBtn.disabled}`, 'info');
                log(`ä½ç½®å’Œå¤§å°: ${rect.left}, ${rect.top}, ${rect.width}, ${rect.height}`, 'info');
                
                // æµ‹è¯•äº‹ä»¶ç›‘å¬å™¨
                const testListener = () => {
                    log('âœ… æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨æ­£å¸¸å·¥ä½œ', 'success');
                };
                
                leaveBtn.addEventListener('mouseenter', testListener, { once: true });
                
                // è§¦å‘é¼ æ ‡è¿›å…¥äº‹ä»¶
                const mouseEnterEvent = new MouseEvent('mouseenter', { bubbles: true });
                leaveBtn.dispatchEvent(mouseEnterEvent);
                
            } else {
                log('âŒ æœªæ‰¾åˆ°ç¦»å¼€æˆ¿é—´æŒ‰é’®', 'error');
            }
        }
        
        function testFirebaseConnection() {
            log('ğŸ”¥ æµ‹è¯•Firebaseè¿æ¥...', 'info');
            
            if (window.parent.firebaseApp) {
                log('âœ… Firebase Appå·²åˆå§‹åŒ–', 'success');
            } else {
                log('âŒ Firebase Appæœªåˆå§‹åŒ–', 'error');
            }
            
            if (window.parent.firebaseDatabase) {
                log('âœ… Firebase Databaseå·²åˆå§‹åŒ–', 'success');
            } else {
                log('âŒ Firebase Databaseæœªåˆå§‹åŒ–', 'error');
            }
            
            if (navigator.onLine) {
                log('âœ… ç½‘ç»œè¿æ¥æ­£å¸¸', 'success');
            } else {
                log('âŒ ç½‘ç»œè¿æ¥æ–­å¼€', 'error');
            }
        }
        
        function testLeaveRoom() {
            log('ğŸ§ª æµ‹è¯•ç¦»å¼€æˆ¿é—´åŠŸèƒ½...', 'info');
            
            if (window.parent.app && window.parent.app.firebaseManager) {
                const fm = window.parent.app.firebaseManager;
                
                if (!fm.roomId) {
                    log('âŒ å½“å‰æ²¡æœ‰åŠ å…¥ä»»ä½•æˆ¿é—´', 'warning');
                    return;
                }
                
                log('ğŸšª è°ƒç”¨leaveRoomæ–¹æ³•...', 'info');
                fm.leaveRoom()
                    .then(() => {
                        log('âœ… ç¦»å¼€æˆ¿é—´æˆåŠŸ', 'success');
                    })
                    .catch(error => {
                        log(`âŒ ç¦»å¼€æˆ¿é—´å¤±è´¥: ${error.message}`, 'error');
                        console.error('è¯¦ç»†é”™è¯¯:', error);
                    });
            } else {
                log('âŒ æ— æ³•è®¿é—®FirebaseManager', 'error');
            }
        }
        
        function forceLeaveRoom() {
            log('âš¡ å¼ºåˆ¶ç¦»å¼€æˆ¿é—´...', 'warning');
            
            if (typeof window.parent.debugLeaveRoom === 'function') {
                window.parent.debugLeaveRoom();
                log('âœ… è°ƒç”¨äº†debugLeaveRoom', 'success');
            } else if (window.parent.app && window.parent.app.firebaseManager && typeof window.parent.app.firebaseManager.forceLeaveRoom === 'function') {
                window.parent.app.firebaseManager.forceLeaveRoom();
                log('âœ… è°ƒç”¨äº†forceLeaveRoom', 'success');
            } else {
                log('âŒ æœªæ‰¾åˆ°å¼ºåˆ¶ç¦»å¼€æ–¹æ³•', 'error');
            }
        }
        
        function simulateButtonClick() {
            log('ğŸ–±ï¸ æ¨¡æ‹ŸæŒ‰é’®ç‚¹å‡»...', 'info');
            
            const leaveBtn = window.parent.document.getElementById('leave-room-btn');
            if (leaveBtn) {
                // åˆ›å»ºçœŸå®çš„ç‚¹å‡»äº‹ä»¶
                const clickEvent = new MouseEvent('click', {
                    bubbles: true,
                    cancelable: true,
                    view: window.parent,
                    button: 0,
                    buttons: 1,
                    clientX: leaveBtn.getBoundingClientRect().left + leaveBtn.offsetWidth / 2,
                    clientY: leaveBtn.getBoundingClientRect().top + leaveBtn.offsetHeight / 2
                });
                
                log('å‘é€ç‚¹å‡»äº‹ä»¶...', 'info');
                leaveBtn.dispatchEvent(clickEvent);
                log('âœ… ç‚¹å‡»äº‹ä»¶å·²å‘é€', 'success');
            } else {
                log('âŒ æœªæ‰¾åˆ°ç¦»å¼€æˆ¿é—´æŒ‰é’®', 'error');
            }
        }
        
        // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ¶ˆæ¯
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'firebase-log') {
                log(event.data.message, event.data.level || 'info');
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡ŒåŸºç¡€è¯Šæ–­
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åŸºç¡€æ£€æŸ¥...', 'info');
                checkRoomStatus();
                checkLeaveButton();
            }, 1000);
        });
    </script>
</body>
</html>
