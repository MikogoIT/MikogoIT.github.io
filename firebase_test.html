<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebaseè¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .console {
            background: #1e1e1e;
            color: #ffffff;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .instructions {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¥ Firebaseè¿æ¥æµ‹è¯•</h1>
        
        <div class="instructions">
            <h3>ğŸ“‹ æµ‹è¯•å‰è¯·ç¡®è®¤ï¼š</h3>
            <ol>
                <li>âœ… å·²åœ¨Firebaseæ§åˆ¶å°å¯ç”¨<strong>åŒ¿åè®¤è¯</strong></li>
                <li>âœ… å·²é…ç½®<strong>Realtime Databaseå®‰å…¨è§„åˆ™</strong></li>
                <li>âœ… ç½‘ç»œè¿æ¥æ­£å¸¸</li>
            </ol>
            <p>ğŸ”§ å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ <code>FIREBASE_DEBUG.md</code> æ–‡ä»¶è·å–è¯¦ç»†è§£å†³æ–¹æ¡ˆã€‚</p>
        </div>
        
        <div>
            <button onclick="testFirebaseConnection()">ğŸ§ª å¼€å§‹æµ‹è¯•</button>
            <button onclick="clearConsole()">ğŸ—‘ï¸ æ¸…ç©ºæ§åˆ¶å°</button>
        </div>
        
        <div id="console" class="console">
            æ§åˆ¶å°è¾“å‡ºå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
        </div>
    </div>

    <!-- Firebase v9+ SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
        import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

        // ä½ çš„Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBgbodFry-hFl_tiWK9CAYzZ_4FFizc3kE",
            authDomain: "pig-timer-collaboration.firebaseapp.com",
            databaseURL: "https://pig-timer-collaboration-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pig-timer-collaboration",
            storageBucket: "pig-timer-collaboration.firebasestorage.app",
            messagingSenderId: "629352460916",
            appId: "1:629352460916:web:248d4051b64d8cb4e51721",
            measurementId: "G-5RMRLLTTRP"
        };

        // æ§åˆ¶å°è¾“å‡ºå‡½æ•°
        function logToConsole(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#ffffff',
                success: '#4caf50',
                error: '#f44336',
                warning: '#ff9800'
            };
            
            console.innerHTML += `<div style="color: ${colors[type]}; margin: 5px 0;">${timestamp} - ${message}</div>`;
            console.scrollTop = console.scrollHeight;
            
            // åŒæ—¶è¾“å‡ºåˆ°æµè§ˆå™¨æ§åˆ¶å°
            if (type === 'error') {
                console.error(`${timestamp} - ${message}`);
            } else {
                console.log(`${timestamp} - ${message}`);
            }
        }

        // æµ‹è¯•Firebaseè¿æ¥
        async function testFirebaseConnection() {
            logToConsole('ğŸ”„ å¼€å§‹Firebaseè¿æ¥æµ‹è¯•...', 'info');
            
            try {
                // æ­¥éª¤1ï¼šåˆå§‹åŒ–Firebaseåº”ç”¨
                logToConsole('ğŸ“± åˆå§‹åŒ–Firebaseåº”ç”¨...', 'info');
                const app = initializeApp(firebaseConfig);
                logToConsole('âœ… Firebaseåº”ç”¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                // æ­¥éª¤2ï¼šè·å–è®¤è¯å’Œæ•°æ®åº“å®ä¾‹
                const auth = getAuth(app);
                const database = getDatabase(app);
                logToConsole('ğŸ”§ è·å–FirebaseæœåŠ¡å®ä¾‹æˆåŠŸ', 'success');
                
                // æ­¥éª¤3ï¼šåŒ¿åç™»å½•
                logToConsole('ğŸ” å¼€å§‹åŒ¿åç”¨æˆ·è®¤è¯...', 'info');
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;
                logToConsole(`âœ… åŒ¿åç™»å½•æˆåŠŸï¼Œç”¨æˆ·ID: ${user.uid.substring(0, 8)}...`, 'success');
                
                // æ­¥éª¤4ï¼šæµ‹è¯•æ•°æ®åº“è¿æ¥çŠ¶æ€
                logToConsole('ğŸŒ æµ‹è¯•æ•°æ®åº“è¿æ¥çŠ¶æ€...', 'info');
                const connectionRef = ref(database, '.info/connected');
                
                onValue(connectionRef, (snapshot) => {
                    const connected = snapshot.val();
                    if (connected) {
                        logToConsole('âœ… Firebase Realtime Databaseè¿æ¥æˆåŠŸ', 'success');
                        
                        // æ­¥éª¤5ï¼šæµ‹è¯•æ•°æ®åº“è¯»å†™æƒé™
                        testDatabasePermissions(database, user.uid);
                    } else {
                        logToConsole('âŒ Firebase Realtime Databaseè¿æ¥å¤±è´¥', 'error');
                        logToConsole('ğŸ’¡ è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒFirebaseé¡¹ç›®çŠ¶æ€', 'warning');
                    }
                });
                
            } catch (error) {
                logToConsole(`âŒ Firebaseè¿æ¥å¤±è´¥: ${error.code} - ${error.message}`, 'error');
                
                // æä¾›å…·ä½“çš„é”™è¯¯è§£å†³å»ºè®®
                if (error.code === 'auth/invalid-api-key') {
                    logToConsole('ğŸ”§ è§£å†³æ–¹æ¡ˆ: æ£€æŸ¥Firebaseé…ç½®ä¸­çš„APIå¯†é’¥æ˜¯å¦æ­£ç¡®', 'warning');
                } else if (error.code === 'auth/network-request-failed') {
                    logToConsole('ğŸ”§ è§£å†³æ–¹æ¡ˆ: æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œå¯èƒ½éœ€è¦ç§‘å­¦ä¸Šç½‘', 'warning');
                } else if (error.code === 'auth/operation-not-allowed') {
                    logToConsole('ğŸ”§ è§£å†³æ–¹æ¡ˆ: éœ€è¦åœ¨Firebaseæ§åˆ¶å°å¯ç”¨åŒ¿åè®¤è¯', 'warning');
                    logToConsole('ğŸ“– è¯¦ç»†æ­¥éª¤: Authentication â†’ ç™»å½•æ–¹æ³• â†’ åŒ¿å â†’ å¯ç”¨', 'warning');
                } else if (error.message.includes('Invalid token in path')) {
                    logToConsole('ğŸ”§ è§£å†³æ–¹æ¡ˆ: éœ€è¦å¯ç”¨åŒ¿åè®¤è¯å¹¶é…ç½®æ•°æ®åº“å®‰å…¨è§„åˆ™', 'warning');
                    logToConsole('ğŸ“– è¯¦ç»†æ­¥éª¤è¯·æŸ¥çœ‹ FIREBASE_DEBUG.md æ–‡ä»¶', 'warning');
                } else {
                    logToConsole('ğŸ”§ é€šç”¨è§£å†³æ–¹æ¡ˆ: æ£€æŸ¥Firebaseé¡¹ç›®é…ç½®å’Œç½‘ç»œè¿æ¥', 'warning');
                }
            }
        }
        
        // æµ‹è¯•æ•°æ®åº“æƒé™
        async function testDatabasePermissions(database, userId) {
            try {
                logToConsole('ğŸ“ æµ‹è¯•æ•°æ®åº“å†™å…¥æƒé™...', 'info');
                
                const testData = {
                    userId: userId,
                    timestamp: Date.now(),
                    message: 'Firebaseæƒé™æµ‹è¯•',
                    testType: 'connection_test'
                };
                
                const testRef = ref(database, `test/${userId}`);
                await set(testRef, testData);
                logToConsole('âœ… æ•°æ®åº“å†™å…¥æƒé™æµ‹è¯•æˆåŠŸ', 'success');
                
                // æµ‹è¯•è¯»å–æƒé™
                logToConsole('ğŸ“– æµ‹è¯•æ•°æ®åº“è¯»å–æƒé™...', 'info');
                const snapshot = await get(testRef);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    logToConsole('âœ… æ•°æ®åº“è¯»å–æƒé™æµ‹è¯•æˆåŠŸ', 'success');
                    logToConsole(`ğŸ“„ è¯»å–åˆ°çš„æ•°æ®: ${JSON.stringify(data)}`, 'info');
                    logToConsole('ğŸ‰ Firebaseå®Œå…¨é…ç½®æˆåŠŸï¼å¯ä»¥å¼€å§‹ä½¿ç”¨å¤šäººåä½œåŠŸèƒ½ã€‚', 'success');
                } else {
                    logToConsole('âš ï¸ æ•°æ®åº“è¯»å–æµ‹è¯•å¤±è´¥ï¼šæ•°æ®ä¸å­˜åœ¨', 'warning');
                }
                
            } catch (error) {
                logToConsole(`âŒ æ•°æ®åº“æ“ä½œå¤±è´¥: ${error.code} - ${error.message}`, 'error');
                
                if (error.code === 'PERMISSION_DENIED' || error.message.includes('permission-denied')) {
                    logToConsole('ğŸ”§ è§£å†³æ–¹æ¡ˆ: æ•°æ®åº“å®‰å…¨è§„åˆ™ä¸å…è®¸å½“å‰ç”¨æˆ·æ“ä½œ', 'warning');
                    logToConsole('ğŸ“– è¯·æŒ‰ç…§ FIREBASE_DEBUG.md ä¸­çš„æ­¥éª¤é…ç½®å®‰å…¨è§„åˆ™', 'warning');
                    logToConsole('âš¡ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ: åœ¨æ•°æ®åº“è§„åˆ™ä¸­è®¾ç½® ".read": true, ".write": true', 'warning');
                }
            }
        }
        
        // æ¸…ç©ºæ§åˆ¶å°
        function clearConsole() {
            document.getElementById('console').innerHTML = 'æ§åˆ¶å°å·²æ¸…ç©ºï¼Œå‡†å¤‡æ–°çš„æµ‹è¯•...';
        }
        
        // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.testFirebaseConnection = testFirebaseConnection;
        window.clearConsole = clearConsole;
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œä¸€æ¬¡æµ‹è¯•
        window.addEventListener('load', () => {
            logToConsole('ğŸš€ Firebaseæµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
            logToConsole('ğŸ‘† ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®å¼€å§‹æ£€æµ‹Firebaseè¿æ¥çŠ¶æ€', 'info');
        });
    </script>
</body>
</html>
