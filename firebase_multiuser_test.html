<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebaseå¤šç”¨æˆ·æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section {
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .test-section h3 {
            margin: 0 0 15px 0;
            color: #333;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .status {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .room-info {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .user-list {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }
        
        .user-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
    </style>
    
    <!-- Firebase SDK (v9+ - ç°ä»£æ¨¡å—åŒ–è¯­æ³•) -->
    <script type="module">
        // å…¨å±€Firebaseé…ç½®å’Œåˆå§‹åŒ–
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, push, remove, update, serverTimestamp, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBgbodFry-hFl_tiWK9CAYzZ_4FFizc3kE",
            authDomain: "pig-timer-collaboration.firebaseapp.com",
            databaseURL: "https://pig-timer-collaboration-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pig-timer-collaboration",
            storageBucket: "pig-timer-collaboration.firebasestorage.app",
            messagingSenderId: "629352460916",
            appId: "1:629352460916:web:248d4051b64d8cb4e51721",
            measurementId: "G-5RMRLLTTRP"
        };
        
        // åˆå§‹åŒ–Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        
        // å°†Firebaseå®ä¾‹æš´éœ²ç»™å…¨å±€ä½œç”¨åŸŸ
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDatabase = database;
        window.firebaseUtils = {
            signInAnonymously,
            onAuthStateChanged,
            ref,
            set,
            get,
            onValue,
            push,
            remove,
            update,
            serverTimestamp,
            onDisconnect
        };
        
        console.log('âœ… Firebase v9+ åˆå§‹åŒ–å®Œæˆ');
    </script>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¥ Firebaseå¤šç”¨æˆ·åä½œæµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>ç”¨æˆ·èº«ä»½</h3>
            <div id="user-status" class="status">æ­£åœ¨åˆå§‹åŒ–...</div>
            <button onclick="initUser()">åˆå§‹åŒ–ç”¨æˆ·</button>
        </div>
        
        <div class="test-section">
            <h3>æˆ¿é—´æ“ä½œ</h3>
            <button onclick="createRoom()">åˆ›å»ºæµ‹è¯•æˆ¿é—´</button>
            <button onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
            <button onclick="leaveRoom()">ç¦»å¼€æˆ¿é—´</button>
            <div id="room-status" class="room-info">æš‚æ— æˆ¿é—´</div>
        </div>
        
        <div class="test-section">
            <h3>ç”¨æˆ·åˆ—è¡¨</h3>
            <div id="users-display" class="user-list">æš‚æ— ç”¨æˆ·</div>
            <button onclick="debugUsers()">è°ƒè¯•ç”¨æˆ·æ•°æ®</button>
        </div>
        
        <div class="test-section">
            <h3>æ“ä½œæ—¥å¿—</h3>
            <div id="log" class="status" style="height: 200px; overflow-y: auto;"></div>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentRoom = null;
        let usersListener = null;
        
        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // åˆå§‹åŒ–ç”¨æˆ·
        async function initUser() {
            try {
                log('å¼€å§‹ç”¨æˆ·è®¤è¯...');
                
                const userCredential = await window.firebaseUtils.signInAnonymously(window.firebaseAuth);
                currentUser = {
                    id: userCredential.user.uid,
                    name: `ç”¨æˆ·_${Math.random().toString(36).substring(7)}`,
                    color: `#${Math.floor(Math.random()*16777215).toString(16)}`
                };
                
                document.getElementById('user-status').textContent = 
                    `ç”¨æˆ·ID: ${currentUser.id}\nç”¨æˆ·å: ${currentUser.name}\né¢œè‰²: ${currentUser.color}`;
                
                log(`âœ… ç”¨æˆ·è®¤è¯æˆåŠŸ: ${currentUser.name} (${currentUser.id})`);
                
            } catch (error) {
                log(`âŒ ç”¨æˆ·è®¤è¯å¤±è´¥: ${error.message}`);
            }
        }
        
        // åˆ›å»ºæˆ¿é—´
        async function createRoom() {
            if (!currentUser) {
                log('âŒ è¯·å…ˆåˆå§‹åŒ–ç”¨æˆ·');
                return;
            }
            
            try {
                const roomId = `test_room_${Date.now().toString(36)}`;
                const roomData = {
                    info: {
                        hostId: currentUser.id,
                        hostName: currentUser.name,
                        created: window.firebaseUtils.serverTimestamp(),
                        lastActivity: window.firebaseUtils.serverTimestamp(),
                        isActive: true
                    },
                    users: {
                        [currentUser.id]: {
                            userName: currentUser.name,
                            userColor: currentUser.color,
                            isHost: true,
                            lastSeen: window.firebaseUtils.serverTimestamp(),
                            isOnline: true
                        }
                    }
                };
                
                const roomRef = window.firebaseUtils.ref(window.firebaseDatabase, `rooms/${roomId}`);
                await window.firebaseUtils.set(roomRef, roomData);
                
                currentRoom = roomId;
                
                document.getElementById('room-status').innerHTML = 
                    `æˆ¿é—´ID: ${roomId}<br>è§’è‰²: æˆ¿ä¸»<br>çŠ¶æ€: æ´»è·ƒ`;
                
                // è®¾ç½®ç”¨æˆ·ç›‘å¬
                setupUsersListener(roomId);
                
                log(`âœ… æˆ¿é—´åˆ›å»ºæˆåŠŸ: ${roomId}`);
                
            } catch (error) {
                log(`âŒ æˆ¿é—´åˆ›å»ºå¤±è´¥: ${error.message}`);
            }
        }
        
        // åŠ å…¥æˆ¿é—´
        async function joinRoom() {
            if (!currentUser) {
                log('âŒ è¯·å…ˆåˆå§‹åŒ–ç”¨æˆ·');
                return;
            }
            
            const roomId = prompt('è¯·è¾“å…¥æˆ¿é—´ID:');
            if (!roomId) return;
            
            try {
                // æ£€æŸ¥æˆ¿é—´æ˜¯å¦å­˜åœ¨
                const roomRef = window.firebaseUtils.ref(window.firebaseDatabase, `rooms/${roomId}`);
                const roomSnapshot = await window.firebaseUtils.get(roomRef);
                
                if (!roomSnapshot.exists()) {
                    log(`âŒ æˆ¿é—´ä¸å­˜åœ¨: ${roomId}`);
                    return;
                }
                
                // æ·»åŠ ç”¨æˆ·åˆ°æˆ¿é—´
                const userRef = window.firebaseUtils.ref(window.firebaseDatabase, `rooms/${roomId}/users/${currentUser.id}`);
                await window.firebaseUtils.set(userRef, {
                    userName: currentUser.name,
                    userColor: currentUser.color,
                    isHost: false,
                    lastSeen: window.firebaseUtils.serverTimestamp(),
                    isOnline: true
                });
                
                currentRoom = roomId;
                
                document.getElementById('room-status').innerHTML = 
                    `æˆ¿é—´ID: ${roomId}<br>è§’è‰²: æˆå‘˜<br>çŠ¶æ€: æ´»è·ƒ`;
                
                // è®¾ç½®ç”¨æˆ·ç›‘å¬
                setupUsersListener(roomId);
                
                log(`âœ… æˆåŠŸåŠ å…¥æˆ¿é—´: ${roomId}`);
                
            } catch (error) {
                log(`âŒ åŠ å…¥æˆ¿é—´å¤±è´¥: ${error.message}`);
            }
        }
        
        // ç¦»å¼€æˆ¿é—´
        async function leaveRoom() {
            if (!currentRoom || !currentUser) {
                log('âŒ æ²¡æœ‰æ´»è·ƒçš„æˆ¿é—´');
                return;
            }
            
            try {
                // ç§»é™¤ç”¨æˆ·
                const userRef = window.firebaseUtils.ref(window.firebaseDatabase, `rooms/${currentRoom}/users/${currentUser.id}`);
                await window.firebaseUtils.remove(userRef);
                
                // æ¸…ç†ç›‘å¬å™¨
                if (usersListener) {
                    usersListener = null;
                }
                
                document.getElementById('room-status').textContent = 'æš‚æ— æˆ¿é—´';
                document.getElementById('users-display').textContent = 'æš‚æ— ç”¨æˆ·';
                
                log(`âœ… å·²ç¦»å¼€æˆ¿é—´: ${currentRoom}`);
                currentRoom = null;
                
            } catch (error) {
                log(`âŒ ç¦»å¼€æˆ¿é—´å¤±è´¥: ${error.message}`);
            }
        }
        
        // è®¾ç½®ç”¨æˆ·ç›‘å¬
        function setupUsersListener(roomId) {
            if (usersListener) {
                // æ¸…ç†æ—§çš„ç›‘å¬å™¨
                usersListener = null;
            }
            
            const usersRef = window.firebaseUtils.ref(window.firebaseDatabase, `rooms/${roomId}/users`);
            usersListener = window.firebaseUtils.onValue(usersRef, (snapshot) => {
                const users = snapshot.val();
                log(`ğŸ”¥ ç”¨æˆ·æ•°æ®æ›´æ–°: ${JSON.stringify(users)}`);
                updateUsersDisplay(users);
            });
            
            log(`âœ… ç”¨æˆ·ç›‘å¬å™¨å·²è®¾ç½®: ${roomId}`);
        }
        
        // æ›´æ–°ç”¨æˆ·æ˜¾ç¤º
        function updateUsersDisplay(users) {
            const usersDiv = document.getElementById('users-display');
            
            if (!users) {
                usersDiv.innerHTML = 'æš‚æ— ç”¨æˆ·';
                return;
            }
            
            const userEntries = Object.entries(users);
            const userCount = userEntries.length;
            
            let html = `<strong>ç”¨æˆ·æ•°: ${userCount}</strong><br>`;
            
            userEntries.forEach(([userId, userData]) => {
                const isCurrentUser = userId === currentUser?.id;
                const userName = userData.userName || 'æœªçŸ¥ç”¨æˆ·';
                const userColor = userData.userColor || '#ccc';
                const isHost = userData.isHost ? ' (æˆ¿ä¸»)' : '';
                const isOnline = userData.isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿';
                
                html += `
                    <div class="user-item">
                        <div class="user-color" style="background-color: ${userColor}"></div>
                        <span>${userName}${isCurrentUser ? ' (æˆ‘)' : ''}${isHost}</span>
                        <span style="margin-left: auto; color: ${userData.isOnline ? 'green' : 'red'}">${isOnline}</span>
                    </div>
                `;
            });
            
            usersDiv.innerHTML = html;
        }
        
        // è°ƒè¯•ç”¨æˆ·æ•°æ®
        async function debugUsers() {
            if (!currentRoom) {
                log('âŒ æ²¡æœ‰æ´»è·ƒçš„æˆ¿é—´');
                return;
            }
            
            try {
                const usersRef = window.firebaseUtils.ref(window.firebaseDatabase, `rooms/${currentRoom}/users`);
                const snapshot = await window.firebaseUtils.get(usersRef);
                const users = snapshot.val();
                
                log(`ğŸ” è°ƒè¯• - æˆ¿é—´ ${currentRoom} çš„ç”¨æˆ·æ•°æ®:`);
                log(JSON.stringify(users, null, 2));
                
            } catch (error) {
                log(`âŒ è°ƒè¯•å¤±è´¥: ${error.message}`);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆå§‹åŒ–
        window.addEventListener('load', () => {
            setTimeout(() => {
                initUser();
            }, 1000);
        });
    </script>
</body>
</html>
