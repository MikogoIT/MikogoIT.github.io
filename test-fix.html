<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘çŒªç›‘æ§ç³»ç»Ÿ - é—®é¢˜éªŒè¯æµ‹è¯•</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #2c3e50; 
            color: white; 
        }
        .test-container { 
            display: grid; 
            grid-template-columns: 300px 1fr; 
            gap: 20px; 
            margin: 20px 0; 
        }
        .controls { 
            background: rgba(0,0,0,0.5); 
            padding: 20px; 
            border-radius: 10px; 
        }
        .test-grid { 
            display: grid; 
            grid-template-columns: repeat(10, 50px); 
            gap: 5px; 
            margin: 10px 0; 
        }
        .test-cell { 
            width: 50px; 
            height: 50px; 
            border: 1px solid #ccc; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            cursor: pointer; 
            position: relative;
            background: linear-gradient(to bottom right, #34495e, #2c3e50);
            color: white;
            border-radius: 5px;
            font-weight: bold;
        }
        .test-cell.killed { 
            background: linear-gradient(to bottom right, #e74c3c, #c0392b); 
        }
        .test-cell.killed-unknown { 
            background: linear-gradient(to bottom right, #e67e22, #d35400); 
        }
        .test-cell.refreshed { 
            background: linear-gradient(to bottom right, #2ecc71, #27ae60); 
        }
        .timer-display { 
            position: absolute; 
            bottom: 2px; 
            left: 2px; 
            right: 2px; 
            font-size: 8px; 
            background: rgba(0,0,0,0.8); 
            color: white; 
            border-radius: 2px; 
            padding: 1px; 
            text-align: center; 
        }
        .stats { 
            background: rgba(0,0,0,0.3); 
            padding: 15px; 
            border-radius: 10px; 
            margin: 10px 0; 
        }
        .stat-item { 
            display: flex; 
            justify-content: space-between; 
            margin: 5px 0; 
        }
        .log { 
            background: #1a1a1a; 
            padding: 10px; 
            margin: 10px 0; 
            height: 150px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 11px; 
            border-radius: 5px;
        }
        button { 
            margin: 5px 0; 
            padding: 8px 12px; 
            background: #3498db; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            width: 100%;
        }
        button:hover { background: #2980b9; }
        .test-mode { background: #e67e22; }
        .test-mode:hover { background: #d35400; }
    </style>
</head>
<body>
    <h1>ğŸ· é‡‘çŒªç›‘æ§ç³»ç»Ÿ - é—®é¢˜éªŒè¯æµ‹è¯•</h1>
    
    <div class="test-container">
        <div class="controls">
            <h3>ğŸ“Š å®æ—¶ç»Ÿè®¡</h3>
            <div class="stats">
                <div class="stat-item">
                    <span>å‡»æ€ä¸­:</span>
                    <span id="test-killed">0</span>
                </div>
                <div class="stat-item">
                    <span>æœªçŸ¥æ—¶é—´:</span>
                    <span id="test-unknown">0</span>
                </div>
                <div class="stat-item">
                    <span>å·²åˆ·æ–°:</span>
                    <span id="test-refreshed">0</span>
                </div>
                <div class="stat-item">
                    <span>å¯ç”¨:</span>
                    <span id="test-available">20</span>
                </div>
                <div class="stat-item">
                    <span><strong>ä»Šæ—¥å‡»æ€:</strong></span>
                    <span id="test-today"><strong>0</strong></span>
                </div>
            </div>
            
            <h3>ğŸ® æµ‹è¯•æ§åˆ¶</h3>
            <button onclick="toggleTestMode()" id="test-mode-btn">å¼€å¯æµ‹è¯•æ¨¡å¼ (10ç§’)</button>
            <button onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
            <button onclick="refreshStats()">åˆ·æ–°ç»Ÿè®¡</button>
            <button onclick="showKillEvents()">æ˜¾ç¤ºå‡»æ€äº‹ä»¶</button>
            
            <h3>ğŸ“ æ“ä½œæ—¥å¿—</h3>
            <div class="log" id="test-log"></div>
            <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>
        
        <div>
            <h3>ğŸ¯ æµ‹è¯•ç½‘æ ¼ (å‰20ä¸ªçº¿è·¯)</h3>
            <p><strong>æ“ä½œè¯´æ˜:</strong></p>
            <ul>
                <li>å·¦é”® = å‡»æ€ (çº¢è‰² + å€’è®¡æ—¶)</li>
                <li>å³é”® = å‡»æ€æœªçŸ¥æ—¶é—´ (æ©™è‰²)</li>
                <li>åŒå‡» = å–æ¶ˆçŠ¶æ€</li>
            </ul>
            <div class="test-grid" id="test-grid"></div>
        </div>
    </div>

    <script type="module">
        import { GAME_CONFIG } from './js/config.js';
        import { TimerManager } from './js/modules/timerManager.js';
        import { StatsManager } from './js/modules/statsManager.js';
        import { StorageManager } from './js/modules/storageManager.js';
        import { AnimationManager } from './js/modules/animationManager.js';
        import { UIManager } from './js/modules/uiManager.js';
        import { EventManager } from './js/modules/eventManager.js';

        // å…¨å±€çŠ¶æ€
        let testMode = false;
        let managers = {};

        // åˆå§‹åŒ–ç®¡ç†å™¨
        function initManagers() {
            try {
                managers.storage = new StorageManager();
                managers.stats = new StatsManager();
                managers.animation = new AnimationManager();
                managers.ui = new UIManager();
                managers.timer = new TimerManager(managers.storage);
                managers.event = new EventManager(
                    managers.timer, 
                    managers.stats, 
                    managers.animation, 
                    managers.ui, 
                    managers.storage
                );
                
                log('âœ… æ‰€æœ‰ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ');
                
                // ç¡®ä¿ç»Ÿè®¡ç®¡ç†å™¨å…ƒç´ ç»‘å®š
                setTimeout(() => {
                    managers.stats.bindElements();
                    log('âœ… ç»Ÿè®¡ç®¡ç†å™¨å…ƒç´ ç»‘å®šå®Œæˆ');
                }, 100);
                
            } catch (error) {
                log(`âŒ ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
            }
        }

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logDiv = document.getElementById('test-log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[TEST] ${message}`);
        }

        // åˆ›å»ºæµ‹è¯•ç½‘æ ¼
        function createTestGrid() {
            const grid = document.getElementById('test-grid');
            for (let i = 1; i <= 20; i++) {
                const cell = document.createElement('div');
                cell.className = 'test-cell';
                cell.dataset.line = i;
                cell.textContent = i;
                
                // æ·»åŠ å®šæ—¶å™¨æ˜¾ç¤º
                const timer = document.createElement('div');
                timer.id = `timer-${i}`;
                timer.className = 'timer-display';
                cell.appendChild(timer);
                
                // ç»‘å®šäº‹ä»¶
                cell.addEventListener('click', (e) => {
                    log(`ğŸ–±ï¸ å·¦é”®ç‚¹å‡»çº¿è·¯ ${i}`);
                    if (managers.event) {
                        managers.event.handleCellClick(e);
                        setTimeout(updateTestStats, 100);
                    }
                });
                
                cell.addEventListener('contextmenu', (e) => {
                    log(`ğŸ‘† å³é”®ç‚¹å‡»çº¿è·¯ ${i}`);
                    if (managers.event) {
                        managers.event.handleCellRightClick(e);
                        setTimeout(updateTestStats, 100);
                    }
                });
                
                cell.addEventListener('dblclick', (e) => {
                    log(`ğŸ”„ åŒå‡»çº¿è·¯ ${i}`);
                    if (managers.event) {
                        managers.event.handleCellDoubleClick(e);
                        setTimeout(updateTestStats, 100);
                    }
                });
                
                grid.appendChild(cell);
            }
            log('ğŸ¯ æµ‹è¯•ç½‘æ ¼åˆ›å»ºå®Œæˆ');
        }

        // æ›´æ–°æµ‹è¯•ç»Ÿè®¡
        function updateTestStats() {
            const cells = document.querySelectorAll('.test-cell');
            let killed = 0, unknown = 0, refreshed = 0, available = 0;
            
            cells.forEach(cell => {
                if (cell.classList.contains('killed')) killed++;
                else if (cell.classList.contains('killed-unknown')) unknown++;
                else if (cell.classList.contains('refreshed')) refreshed++;
                else available++;
            });
            
            document.getElementById('test-killed').textContent = killed;
            document.getElementById('test-unknown').textContent = unknown;
            document.getElementById('test-refreshed').textContent = refreshed;
            document.getElementById('test-available').textContent = available;
            
            // è·å–ä»Šæ—¥å‡»æ€æ•°
            if (managers.stats) {
                const todayCount = managers.stats.getTodayKillCount();
                document.getElementById('test-today').textContent = todayCount;
                log(`ğŸ“Š ç»Ÿè®¡æ›´æ–°: å‡»æ€=${killed}, æœªçŸ¥=${unknown}, åˆ·æ–°=${refreshed}, å¯ç”¨=${available}, ä»Šæ—¥=${todayCount}`);
            }
        }

        // å…¨å±€å‡½æ•°
        window.toggleTestMode = function() {
            testMode = !testMode;
            if (managers.timer) {
                managers.timer.setTestMode(testMode);
            }
            const btn = document.getElementById('test-mode-btn');
            if (testMode) {
                btn.textContent = 'å…³é—­æµ‹è¯•æ¨¡å¼ (24å°æ—¶)';
                btn.className = 'test-mode';
            } else {
                btn.textContent = 'å¼€å¯æµ‹è¯•æ¨¡å¼ (10ç§’)';
                btn.className = '';
            }
            log(`ğŸ§ª æµ‹è¯•æ¨¡å¼: ${testMode ? 'å¼€å¯ (10ç§’å€’è®¡æ—¶)' : 'å…³é—­ (24å°æ—¶å€’è®¡æ—¶)'}`);
        };

        window.clearAllData = function() {
            // æ¸…é™¤æ ¼å­çŠ¶æ€
            document.querySelectorAll('.test-cell').forEach(cell => {
                cell.className = 'test-cell';
                const timer = cell.querySelector('.timer-display');
                if (timer) timer.textContent = '';
            });
            
            // æ¸…é™¤å­˜å‚¨å’Œè®¡æ—¶å™¨
            localStorage.clear();
            if (managers.timer) managers.timer.clearAllTimers();
            if (managers.stats) {
                managers.stats.killEvents = [];
                managers.stats.bindElements();
            }
            
            updateTestStats();
            log('ğŸ—‘ï¸ æ‰€æœ‰æ•°æ®å·²æ¸…é™¤');
        };

        window.refreshStats = function() {
            if (managers.stats) {
                managers.stats.updateStats();
            }
            updateTestStats();
            log('ğŸ”„ ç»Ÿè®¡å·²åˆ·æ–°');
        };

        window.showKillEvents = function() {
            if (managers.stats) {
                const events = managers.stats.killEvents;
                log(`ğŸ“‹ å‡»æ€äº‹ä»¶åˆ—è¡¨ (${events.length}ä¸ª):`);
                events.forEach((event, index) => {
                    const time = new Date(event.timestamp).toLocaleString();
                    log(`  ${index + 1}. çº¿è·¯${event.line} - ${time}`);
                });
            }
        };

        window.clearLog = function() {
            document.getElementById('test-log').innerHTML = '';
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            initManagers();
            createTestGrid();
            setTimeout(() => {
                updateTestStats();
                log('âœ… æµ‹è¯•ç³»ç»Ÿå°±ç»ª');
            }, 200);
        });
    </script>
</body>
</html>
