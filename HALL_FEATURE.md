# 🏛️ 全球协作大厅功能

## 功能概述

全球协作大厅是金猪刷新监控系统的新功能，允许所有用户在一个共享的全球大厅中协同编辑同一个表格。这是对现有小房间协作功能的补充，提供了更大规模的协作体验。

## 主要特性

### 🌍 全球协作
- 所有加入大厅的用户都在编辑同一个表格
- 无需房间号，直接加入全球大厅
- 支持无限数量的用户同时协作

### ⚡ 实时同步
- 用户的每一个操作都会实时同步到所有其他用户
- 支持击杀标记、时间记录、状态取消等所有操作
- 使用Firebase实时数据库确保数据一致性

### 💾 数据保护机制
- **进入前备份**：加入大厅前自动备份本地数据
- **冲突避免**：大厅操作不会直接覆盖本地数据
- **智能合并**：离开时提供数据合并选项

### 🔄 离开时数据选择
用户离开大厅时可以选择：
1. **合并大厅数据到本地**：将大厅中的最新状态合并到本地
2. **恢复进入前状态**：丢弃大厅中的变更，恢复到进入前的本地状态

## 使用方法

### 1. 加入大厅
1. 在主页面点击协作按钮
2. 在协作面板中选择"🌍 加入全球大厅"
3. 系统会自动备份当前本地数据
4. 成功加入后开始协同编辑

### 2. 协同编辑
- 在表格中进行正常操作（左键击杀、右键标记、双击取消）
- 所有操作会实时同步到其他用户
- 可以看到其他用户的实时操作

### 3. 离开大厅
1. 点击大厅面板中的"🚪 离开大厅"按钮
2. 选择数据处理方式：
   - **合并数据**：保留大厅中的协作结果
   - **恢复本地**：恢复到加入前的状态
3. 确认选择后完成离开

## 技术实现

### 架构设计
```
├── FirebaseCollaborationManager (主协作管理器)
│   ├── HallManager (大厅管理器) 
│   ├── 房间管理功能
│   └── 用户管理功能
│
├── Firebase实时数据库
│   ├── hall/
│   │   └── global_hall/
│   │       ├── users/ (在线用户)
│   │       ├── gameState/ (游戏状态)
│   │       └── info/ (大厅信息)
│   └── rooms/ (私人房间数据)
│
└── EventManager (事件管理器)
    ├── 大厅模式检测
    ├── 条件性本地存储
    └── 状态同步逻辑
```

### 核心模块

#### HallManager.js
- 管理大厅的加入/离开流程
- 处理数据备份和恢复
- 提供数据合并对话框
- 管理大厅用户列表和状态同步

#### 状态同步机制
```javascript
// 检查是否在大厅模式
const isInHall = firebaseManager.isInHallMode();

if (isInHall) {
    // 大厅模式：同步到Firebase，不保存到本地
    await firebaseManager.syncLineStateToHall(lineNumber, state, killTime);
} else {
    // 本地模式：保存到本地存储
    storageManager.setLineState(lineNumber, state);
}
```

### 数据流程

#### 加入大厅流程
1. 用户点击"加入全球大厅"
2. 检查Firebase连接状态
3. 如果在房间中，询问是否离开房间
4. 备份当前本地数据
5. 设置大厅引用和监听器
6. 同步大厅状态到本地显示
7. 显示大厅协作面板

#### 操作同步流程
1. 用户在表格中进行操作
2. EventManager检测到操作事件
3. 检查是否在大厅模式
4. 如果在大厅：
   - 更新UI显示
   - 同步状态到Firebase大厅
   - 不保存到本地存储
5. 如果不在大厅：
   - 更新UI显示
   - 保存到本地存储
   - 同步到房间（如果在房间中）

#### 离开大厅流程
1. 用户点击"离开大厅"
2. 显示数据合并选择对话框
3. 根据用户选择：
   - 合并：获取大厅最新状态，更新本地存储
   - 恢复：使用备份数据恢复本地状态
4. 清理Firebase监听器
5. 重置大厅状态变量
6. 隐藏大厅面板

## 安全和性能考虑

### 数据安全
- 用户数据在离开大厅前始终有备份保护
- 提供明确的数据选择权，避免意外数据丢失
- Firebase安全规则控制数据访问权限

### 性能优化
- 使用Firebase实时监听，减少轮询开销
- 大厅操作不写入本地存储，减少磁盘I/O
- 智能事件监听器管理，避免内存泄漏

### 冲突处理
- 大厅模式下操作不直接修改本地数据
- 提供数据合并时的智能选择机制
- 支持恢复到进入前的状态，确保数据安全

## 测试

### 测试文件
- `hall_test.html`：大厅功能专用测试页面
- 提供状态监控和快速测试功能

### 测试步骤
1. 打开主页面 (`index.html`)
2. 打开测试页面 (`hall_test.html`)
3. 在主页面中加入大厅
4. 在表格中进行各种操作
5. 观察实时同步效果
6. 测试离开大厅的数据选择功能

## 与现有功能的关系

### 与小房间功能的区别
| 特性 | 小房间 | 全球大厅 |
|------|--------|----------|
| 用户数量 | 受限 | 无限 |
| 访问方式 | 房间号 | 直接加入 |
| 数据隔离 | 房间隔离 | 全球共享 |
| 房主概念 | 有房主 | 无房主 |
| 适用场景 | 私人协作 | 公开协作 |

### 兼容性
- 与现有的P2P本地协作完全兼容
- 与Firebase房间协作功能并存
- 不影响单机使用模式

## 未来扩展

### 计划功能
- [ ] 大厅内用户分组功能
- [ ] 大厅操作历史记录
- [ ] 用户权限管理
- [ ] 大厅内聊天功能
- [ ] 数据统计和分析面板

### 性能优化
- [ ] 增量数据同步
- [ ] 客户端数据缓存
- [ ] 网络状态自适应
- [ ] 批量操作支持

## 故障排除

### 常见问题

**Q: 加入大厅失败**
A: 检查网络连接和Firebase配置，确保浏览器支持现代JavaScript特性

**Q: 数据同步延迟**
A: 检查网络状况，Firebase在某些地区可能有延迟

**Q: 离开大厅后数据丢失**
A: 检查是否正确选择了数据合并选项，可以在控制台中查看备份数据

**Q: 无法看到其他用户操作**
A: 确认已成功加入大厅，检查Firebase连接状态

### 调试信息
所有大厅相关操作都会在浏览器控制台中输出详细日志，以便调试和问题定位。

---

*大厅功能为金猪刷新监控系统带来了全新的协作体验，让全球用户能够在一个共享空间中协同工作，同时保护每个用户的本地数据安全。*
