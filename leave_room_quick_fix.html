<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦»å¼€æˆ¿é—´é—®é¢˜ä¸€é”®ä¿®å¤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f8f9fa;
        }
        .fix-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .fix-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 200px;
        }
        .fix-btn:hover {
            background: #c0392b;
        }
        .fix-btn.primary {
            background: #3498db;
        }
        .fix-btn.primary:hover {
            background: #2980b9;
        }
        .status {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-family: monospace;
        }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .info { color: #3498db; }
    </style>
</head>
<body>
    <div class="fix-container">
        <h1>ğŸ”§ ç¦»å¼€æˆ¿é—´é—®é¢˜ä¸€é”®ä¿®å¤</h1>
        
        <div class="status" id="status">
            å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®è¿›è¡Œä¿®å¤...
        </div>
        
        <div style="text-align: center;">
            <h3>ğŸš€ æ¨èä¿®å¤æ–¹æ¡ˆ</h3>
            <button class="fix-btn primary" onclick="runQuickFix()">ä¸€é”®ä¿®å¤æ‰€æœ‰é—®é¢˜</button>
            <br>
            
            <h3>ğŸ”§ åˆ†æ­¥ä¿®å¤</h3>
            <button class="fix-btn" onclick="showRoomInfo()">æ˜¾ç¤ºæˆ¿é—´ä¿¡æ¯æ¡†</button>
            <button class="fix-btn" onclick="fixButton()">ä¿®å¤ç¦»å¼€æŒ‰é’®</button>
            <br>
            
            <h3>ğŸš¨ åº”æ€¥æ–¹æ¡ˆ</h3>
            <button class="fix-btn" onclick="emergencyLeave()">å¼ºåˆ¶ç¦»å¼€æˆ¿é—´</button>
        </div>
        
        <div style="margin-top: 30px;">
            <h3>ğŸ“‹ é—®é¢˜è¯´æ˜</h3>
            <ul>
                <li><strong>é—®é¢˜1:</strong> æ˜¾ç¤ºäº†æ¨¡æ€å¯¹è¯æ¡†è€Œä¸æ˜¯æ‚¬æµ®æˆ¿é—´ä¿¡æ¯æ¡†</li>
                <li><strong>åŸå› :</strong> showCollaborationDialogæ–¹æ³•æ²¡æœ‰æ£€æŸ¥å½“å‰æˆ¿é—´çŠ¶æ€</li>
                <li><strong>ä¿®å¤:</strong> å·²ä¿®æ”¹æ–¹æ³•ï¼Œå½“ç”¨æˆ·åœ¨æˆ¿é—´ä¸­æ—¶ç›´æ¥æ˜¾ç¤ºæˆ¿é—´ä¿¡æ¯æ¡†</li>
            </ul>
            <ul>
                <li><strong>é—®é¢˜2:</strong> ç¦»å¼€æˆ¿é—´æŒ‰é’®ç‚¹å‡»å¤±è´¥</li>
                <li><strong>åŸå› :</strong> äº‹ä»¶ç›‘å¬å™¨ç»‘å®šé—®é¢˜æˆ–CSSæ ·å¼è¦†ç›–</li>
                <li><strong>ä¿®å¤:</strong> é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨å¹¶åº”ç”¨å¼ºåˆ¶æ ·å¼</li>
            </ul>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 5px;">
            <h4>âš ï¸ ä½¿ç”¨è¯´æ˜</h4>
            <ol>
                <li>ç¡®ä¿ä¸»é¡µé¢å·²æ‰“å¼€å¹¶åŠ å…¥äº†æˆ¿é—´</li>
                <li>ç‚¹å‡»"ä¸€é”®ä¿®å¤æ‰€æœ‰é—®é¢˜"æŒ‰é’®</li>
                <li>å¦‚æœé—®é¢˜ä»å­˜åœ¨ï¼Œå°è¯•"å¼ºåˆ¶ç¦»å¼€æˆ¿é—´"</li>
                <li>åˆ·æ–°é¡µé¢åé‡æ–°åŠ å…¥æˆ¿é—´</li>
            </ol>
        </div>
    </div>

    <script>
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            console.log(message);
        }
        
        function runQuickFix() {
            updateStatus('æ­£åœ¨æ‰§è¡Œä¸€é”®ä¿®å¤...', 'info');
            
            try {
                // æ£€æŸ¥æ˜¯å¦èƒ½è®¿é—®ä¸»é¡µé¢
                if (!window.opener && !window.parent.app) {
                    updateStatus('âŒ æ— æ³•è®¿é—®ä¸»é¡µé¢ï¼Œè¯·ç¡®ä¿ä»ä¸»é¡µé¢æ‰“å¼€æ­¤é¡µé¢', 'error');
                    return;
                }
                
                const app = window.opener?.app || window.parent.app;
                if (!app || !app.firebaseManager) {
                    updateStatus('âŒ æ— æ³•è®¿é—®FirebaseManagerï¼Œè¯·ç¡®ä¿ä¸»é¡µé¢å·²åŠ è½½', 'error');
                    return;
                }
                
                const fm = app.firebaseManager;
                
                // 1. æ£€æŸ¥æ˜¯å¦åœ¨æˆ¿é—´ä¸­
                if (!fm.roomId) {
                    updateStatus('âŒ å½“å‰æ²¡æœ‰åŠ å…¥ä»»ä½•æˆ¿é—´', 'error');
                    return;
                }
                
                updateStatus('âœ… æ£€æµ‹åˆ°ç”¨æˆ·åœ¨æˆ¿é—´ä¸­: ' + fm.roomId, 'success');
                
                // 2. å¼ºåˆ¶æ˜¾ç¤ºæˆ¿é—´ä¿¡æ¯æ¡†
                updateStatus('ğŸ  æ˜¾ç¤ºæˆ¿é—´ä¿¡æ¯æ¡†...', 'info');
                fm.showRoomInfo();
                
                // 3. ç­‰å¾…DOMæ›´æ–°åä¿®å¤æŒ‰é’®
                setTimeout(() => {
                    updateStatus('ğŸ”§ ä¿®å¤ç¦»å¼€æˆ¿é—´æŒ‰é’®...', 'info');
                    
                    const leaveBtn = (window.opener || window.parent).document.getElementById('leave-room-btn');
                    if (leaveBtn) {
                        // é‡æ–°ç»‘å®šäº‹ä»¶
                        const newBtn = leaveBtn.cloneNode(true);
                        leaveBtn.parentNode.replaceChild(newBtn, leaveBtn);
                        
                        newBtn.addEventListener('click', async (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            if (confirm('ç¡®å®šè¦ç¦»å¼€æˆ¿é—´å—ï¼Ÿ')) {
                                newBtn.disabled = true;
                                newBtn.textContent = 'ç¦»å¼€ä¸­...';
                                
                                try {
                                    await fm.leaveRoom();
                                    updateStatus('âœ… æˆåŠŸç¦»å¼€æˆ¿é—´', 'success');
                                } catch (error) {
                                    console.error('ç¦»å¼€å¤±è´¥:', error);
                                    updateStatus('âŒ ç¦»å¼€å¤±è´¥: ' + error.message, 'error');
                                    newBtn.disabled = false;
                                    newBtn.textContent = 'ç¦»å¼€æˆ¿é—´';
                                }
                            }
                        });
                        
                        // åº”ç”¨æ ·å¼
                        newBtn.style.cssText = `
                            background: #e74c3c !important;
                            color: white !important;
                            border: none !important;
                            padding: 8px 12px !important;
                            border-radius: 5px !important;
                            cursor: pointer !important;
                            font-size: 13px !important;
                            font-weight: bold !important;
                            opacity: 1 !important;
                            pointer-events: auto !important;
                        `;
                        
                        updateStatus('âœ… ä¸€é”®ä¿®å¤å®Œæˆï¼æˆ¿é—´ä¿¡æ¯æ¡†å·²æ˜¾ç¤ºï¼Œç¦»å¼€æŒ‰é’®å·²ä¿®å¤', 'success');
                    } else {
                        updateStatus('âš ï¸ æœªæ‰¾åˆ°ç¦»å¼€æŒ‰é’®ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨åˆ·æ–°', 'error');
                    }
                }, 500);
                
            } catch (error) {
                console.error('ä¿®å¤å¤±è´¥:', error);
                updateStatus('âŒ ä¿®å¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function showRoomInfo() {
            updateStatus('æ˜¾ç¤ºæˆ¿é—´ä¿¡æ¯æ¡†...', 'info');
            
            try {
                const app = window.opener?.app || window.parent.app;
                if (app && app.firebaseManager && app.firebaseManager.roomId) {
                    app.firebaseManager.showRoomInfo();
                    updateStatus('âœ… æˆ¿é—´ä¿¡æ¯æ¡†å·²æ˜¾ç¤º', 'success');
                } else {
                    updateStatus('âŒ æ— æ³•è®¿é—®FirebaseManageræˆ–ç”¨æˆ·ä¸åœ¨æˆ¿é—´ä¸­', 'error');
                }
            } catch (error) {
                updateStatus('âŒ æ˜¾ç¤ºå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function fixButton() {
            updateStatus('ä¿®å¤ç¦»å¼€æŒ‰é’®...', 'info');
            
            try {
                const targetWindow = window.opener || window.parent;
                const leaveBtn = targetWindow.document.getElementById('leave-room-btn');
                
                if (leaveBtn) {
                    // å¼ºåˆ¶æ ·å¼
                    leaveBtn.style.cssText = `
                        background: #e74c3c !important;
                        color: white !important;
                        border: none !important;
                        padding: 8px 12px !important;
                        border-radius: 5px !important;
                        cursor: pointer !important;
                        font-size: 13px !important;
                        opacity: 1 !important;
                        pointer-events: auto !important;
                        z-index: 10001 !important;
                    `;
                    
                    updateStatus('âœ… ç¦»å¼€æŒ‰é’®æ ·å¼å·²ä¿®å¤', 'success');
                } else {
                    updateStatus('âŒ æœªæ‰¾åˆ°ç¦»å¼€æŒ‰é’®', 'error');
                }
            } catch (error) {
                updateStatus('âŒ ä¿®å¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function emergencyLeave() {
            updateStatus('æ‰§è¡Œåº”æ€¥ç¦»å¼€...', 'info');
            
            if (confirm('ç¡®å®šè¦å¼ºåˆ¶ç¦»å¼€æˆ¿é—´å—ï¼Ÿè¿™å°†æ¸…ç†æ‰€æœ‰æœ¬åœ°çŠ¶æ€ã€‚')) {
                try {
                    const app = window.opener?.app || window.parent.app;
                    if (app && app.firebaseManager) {
                        const fm = app.firebaseManager;
                        
                        // å¼ºåˆ¶æ¸…ç†
                        if (fm.stopHeartbeat) fm.stopHeartbeat();
                        if (fm.removeRoomListeners) fm.removeRoomListeners();
                        
                        fm.roomId = null;
                        fm.isHost = false;
                        fm.roomRef = null;
                        fm.usersRef = null;
                        fm.gameStateRef = null;
                        
                        // éšè—æˆ¿é—´ä¿¡æ¯æ¡†
                        const roomInfo = (window.opener || window.parent).document.getElementById('room-info');
                        if (roomInfo) roomInfo.remove();
                        
                        // æ¸…ç†æœ¬åœ°å­˜å‚¨
                        localStorage.removeItem('firebase_collaboration_roomId');
                        localStorage.removeItem('firebase_collaboration_isHost');
                        
                        updateStatus('âœ… åº”æ€¥ç¦»å¼€å®Œæˆ', 'success');
                    } else {
                        updateStatus('âŒ æ— æ³•è®¿é—®FirebaseManager', 'error');
                    }
                } catch (error) {
                    updateStatus('âŒ åº”æ€¥ç¦»å¼€å¤±è´¥: ' + error.message, 'error');
                }
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', () => {
            try {
                const app = window.opener?.app || window.parent.app;
                if (app && app.firebaseManager) {
                    const fm = app.firebaseManager;
                    if (fm.roomId) {
                        updateStatus(`æ£€æµ‹åˆ°ç”¨æˆ·åœ¨æˆ¿é—´ä¸­: ${fm.roomId}ï¼Œå¯ä»¥å¼€å§‹ä¿®å¤`, 'success');
                    } else {
                        updateStatus('ç”¨æˆ·å½“å‰æ²¡æœ‰åŠ å…¥æˆ¿é—´', 'info');
                    }
                } else {
                    updateStatus('æ— æ³•è®¿é—®ä¸»é¡µé¢ï¼Œè¯·ç¡®ä¿ä»ä¸»é¡µé¢æ‰“å¼€æ­¤ä¿®å¤å·¥å…·', 'error');
                }
            } catch (error) {
                updateStatus('é¡µé¢åŠ è½½æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>
